<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- å¼•å…¥SheetJSç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ========================================
           ç»Ÿä¸€ç™»å½•ç•Œé¢æ ·å¼
           ======================================== */
        
        #unifiedLoginContainer {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            margin: 100px auto;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-title {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        /* ========================================
           ç”¨æˆ·ç•Œé¢å’Œç®¡ç†å‘˜ç•Œé¢æ ·å¼
           ======================================== */
        
        #userInterface,
        #adminInterface {
            display: none;
        }

        #userInterface.active,
        #adminInterface.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            font-weight: 700;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-recharge {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-recharge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.5);
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ·ä¿¡æ¯é¢æ¿ */
        .user-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .user-info-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
        }

        .user-info-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .user-info-value {
            font-size: 22px;
            color: #333;
            font-weight: 700;
        }

        /* ä¿®æ”¹ç”¨æˆ·åæŒ‰é’® */
        .btn-edit-name {
            padding: 4px 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit-name:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* ä¼šå‘˜ç­‰çº§å¾½ç« æ ·å¼ */
        .level-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .level-badge.level-trial {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .level-badge.level-gold {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .level-badge.level-platinum {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        /* ç®¡ç†å‘˜è¡¨æ ¼ä¸­çš„ç­‰çº§é€‰æ‹©å™¨ */
        .level-select {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .level-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .level-select option {
            padding: 8px;
        }

        /* ä¿¡æ¯æç¤ºæ¡† */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
        }

        /* æŸ¥è¯¢åŒºåŸŸ */
        .query-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .btn-batch {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-history {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .action-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* æŸ¥è¯¢è¡¨æ ¼ */
        .query-table,
        .admin-table,
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .query-table th,
        .admin-table th,
        .history-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .query-table td,
        .admin-table td,
        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .query-table input,
        .admin-table input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .query-table input:focus,
        .admin-table input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* æŸ¥è¯¢çŠ¶æ€æ ‡ç­¾ */
        .query-status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .query-status-pending {
            background: #f8f9fa;
            color: #999;
        }

        .query-status-querying {
            background: #fff3cd;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .query-status-success {
            background: #d4edda;
            color: #155724;
        }

        .query-status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        /* å¿«é€’çŠ¶æ€ */
        .express-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .express-status.status-ACCEPT {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .express-status.status-TRANSPORT {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .express-status.status-DELIVERING {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .express-status.status-SIGN {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .express-status.status-PROBLEM,
        .express-status.status-FAILED {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .express-status.status-RETURNED {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .express-status:not([class*="status-"]) {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-query {
            padding: 6px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-query:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-query.btn-detail {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .btn-query.btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-query.btn-requery {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* ç®¡ç†å‘˜è¡¨æ ¼æŒ‰é’® */
        .btn-table {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-table.btn-edit {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-table.btn-disable {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-table:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* ç‰©æµè¯¦æƒ…å±•å¼€è¡Œ */
        .logistics-detail-row {
            background: #f8f9fa;
        }

        .logistics-details {
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logistics-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .logistics-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .logistics-company {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .company-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .company-name {
            font-size: 16px;
            font-weight: 600;
            color: #555;
        }

        .logistics-meta {
            font-size: 13px;
            color: #999;
            margin-bottom: 5px;
        }

        .courier-info {
            color: #667eea;
            font-weight: 600;
        }

        .logistics-info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            min-width: 80px;
        }

        .info-value {
            color: #333;
            flex: 1;
        }

        .logistics-timeline {
            margin-top: 20px;
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logistics-item {
            display: flex;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .logistics-item:last-child {
            border-bottom: none;
        }

        .logistics-time {
            min-width: 150px;
            color: #999;
            font-size: 13px;
            font-weight: 600;
        }

        .logistics-content {
            flex: 1;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
        }

        .logistics-area {
            color: #667eea;
            font-size: 12px;
            margin-top: 5px;
        }

        .logistics-empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* å……å€¼å¼¹çª—å’Œä¿®æ”¹ç”¨æˆ·åå¼¹çª— */
        .recharge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .recharge-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .recharge-modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recharge-modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recharge-modal-header h2 {
            font-size: 22px;
            color: #333;
            font-weight: 700;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            color: #e74c3c;
            transform: rotate(90deg);
        }

        .recharge-modal-body {
            padding: 30px;
        }

        .recharge-modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .modal-btn-cancel:hover {
            background: #e0e0e0;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* å†å²è®°å½•åŒºåŸŸ */
        .history-section {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .history-section.active {
            display: block;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .history-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .history-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .history-empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .history-empty-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .history-empty-hint {
            font-size: 14px;
            color: #999;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
        }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            font-size: 14px;
            font-weight: 600;
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
            color: #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header h1 {
                font-size: 22px;
            }

            .user-panel {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }

            .query-table,
            .admin-table,
            .history-table {
                font-size: 12px;
            }

            .query-table th,
            .query-table td,
            .admin-table th,
            .admin-table td,
            .history-table th,
            .history-table td {
                padding: 8px 5px;
            }

            .logistics-header {
                flex-direction: column;
            }

            .logistics-item {
                flex-direction: column;
                gap: 10px;
            }

            .logistics-time {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========================================
             ç»Ÿä¸€ç™»å½•ç•Œé¢
             ======================================== -->
        <div id="unifiedLoginContainer">
            <h1 class="login-title">ğŸ“¦ å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</h1>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchLoginTab('user')">ç”¨æˆ·ç™»å½•</button>
                <button class="tab-btn" onclick="switchLoginTab('admin')">ç®¡ç†å‘˜</button>
            </div>
            
            <!-- ç”¨æˆ·ç™»å½•è¡¨å• -->
            <div id="userLoginForm" class="login-form active">
                <div class="form-group">
                    <label>ğŸ“± æ‰‹æœºå·</label>
                    <input type="tel" id="loginUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                </div>
                <button class="login-btn" onclick="handleUserLogin()">ç™»å½• / æ³¨å†Œ</button>
            </div>
            
            <!-- ç®¡ç†å‘˜ç™»å½•è¡¨å• -->
            <div id="adminLoginForm" class="login-form">
                <div class="form-group">
                    <label>ğŸ‘¤ ç®¡ç†å‘˜è´¦å·</label>
                    <input type="text" id="adminUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
                </div>
                <div class="form-group">
                    <label>ğŸ”’ å¯†ç </label>
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button class="login-btn" onclick="handleAdminLogin()">ç™»å½•</button>
            </div>
        </div>

        <!-- ========================================
             ç”¨æˆ·ç•Œé¢
             ======================================== -->
        <div id="userInterface">
            <!-- é¡¶éƒ¨å¯¼èˆª -->
            <div class="header">
                <h1>ğŸ“¦ å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</h1>
                <div class="header-buttons">
                    <button class="btn-recharge" onclick="openRechargeModal()">ğŸ’ å……å€¼é¢åº¦</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
            <div class="user-panel">
                <div class="user-info-item">
                    <div class="user-info-label">ğŸ“± æ‰‹æœºå·</div>
                    <div class="user-info-value" id="userPhone">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ğŸ‘¤ ç”¨æˆ·å</div>
                    <div class="user-info-value" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span id="userName">-</span>
                        <button class="btn-edit-name" onclick="openEditNameModal()" title="ä¿®æ”¹ç”¨æˆ·å">âœï¸</button>
                    </div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">â­ ä¼šå‘˜ç­‰çº§</div>
                    <div class="user-info-value">
                        <span class="level-badge" id="userLevelBadge">-</span>
                    </div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ğŸ’ æ€»é¢åº¦</div>
                    <div class="user-info-value" id="totalQuota">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ğŸ“Š å·²ä½¿ç”¨</div>
                    <div class="user-info-value" id="usedQuota">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">âœ¨ å‰©ä½™é¢åº¦</div>
                    <div class="user-info-value" id="remainQuota">-</div>
                </div>
            </div>

            <!-- æŸ¥è¯¢åŒºåŸŸ -->
            <div id="querySection" class="query-section">
                <h2 class="section-title">ğŸ” å¿«é€’æŸ¥è¯¢</h2>
                
                <div class="action-buttons">
                    <button class="btn-add" onclick="addQueryRow()">â• æ·»åŠ æŸ¥è¯¢</button>
                    <button class="btn-batch" onclick="batchQuery()">ğŸš€ æ‰¹é‡æŸ¥è¯¢</button>
                    <button class="btn-export" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                    <button class="btn-history" onclick="showHistorySection()">ğŸ“œ æŸ¥è¯¢å†å²</button>
                    <button class="btn-clear" onclick="clearAllRows()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                </div>

                <table class="query-table">
                    <thead>
                        <tr>
                            <th>å¿«é€’å•å·</th>
                            <th>æ‰‹æœºå·åå››ä½ï¼ˆé€‰å¡«ï¼‰</th>
                            <th>æŸ¥è¯¢çŠ¶æ€</th>
                            <th>å¿«é€’çŠ¶æ€</th>
                            <th>å¿«é€’å…¬å¸</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="queryTableBody">
                        <!-- åŠ¨æ€æ·»åŠ æŸ¥è¯¢è¡Œ -->
                    </tbody>
                </table>
            </div>

            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div id="historySection" class="history-section">
                <h2 class="section-title">ğŸ“œ æŸ¥è¯¢å†å²</h2>
                
                <div class="action-buttons">
                    <button class="btn-add" onclick="showQuerySection()">ğŸ” è¿”å›æŸ¥è¯¢</button>
                    <button class="btn-export" onclick="exportHistoryToExcel()">ğŸ“Š å¯¼å‡ºå†å²</button>
                    <button class="btn-batch" onclick="loadHistoryData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="history-stats">
                    <div class="stat-card">
                        <div class="stat-label">æ€»æŸ¥è¯¢æ¬¡æ•°</div>
                        <div class="stat-value" id="historyTotalCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æˆåŠŸæ¬¡æ•°</div>
                        <div class="stat-value" id="historySuccessCount" style="color: #2ecc71;">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¤±è´¥æ¬¡æ•°</div>
                        <div class="stat-value" id="historyFailedCount" style="color: #e74c3c;">0</div>
                    </div>
                </div>

                <!-- ç­›é€‰å™¨ -->
                <div class="history-filters">
                    <div class="filter-group">
                        <label>å¿«é€’å•å·</label>
                        <input type="text" id="filterExpressNumber" placeholder="è¾“å…¥å¿«é€’å•å·">
                    </div>
                    <div class="filter-group">
                        <label>å¿«é€’å…¬å¸</label>
                        <input type="text" id="filterCompany" placeholder="è¾“å…¥å¿«é€’å…¬å¸">
                    </div>
                    <div class="filter-group">
                        <label>æŸ¥è¯¢çŠ¶æ€</label>
                        <select id="filterStatus">
                            <option value="">å…¨éƒ¨</option>
                            <option value="success">æˆåŠŸ</option>
                            <option value="failed">å¤±è´¥</option>
                        </select>
                    </div>
                    <div class="filter-group" style="display: flex; align-items: flex-end;">
                        <button class="btn-batch" onclick="filterHistory()" style="width: 100%; margin: 0;">ğŸ” ç­›é€‰</button>
                    </div>
                </div>

                <!-- å†å²è®°å½•è¡¨æ ¼ -->
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>æŸ¥è¯¢æ—¶é—´</th>
                            <th>å¿«é€’å•å·</th>
                            <th>æ‰‹æœºå·</th>
                            <th>å¿«é€’å…¬å¸</th>
                            <th>å¿«é€’çŠ¶æ€</th>
                            <th>æŸ¥è¯¢çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- åŠ¨æ€åŠ è½½å†å²è®°å½• -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========================================
             ç®¡ç†å‘˜ç•Œé¢
             ======================================== -->
        <div id="adminInterface">
            <!-- é¡¶éƒ¨å¯¼èˆª -->
            <div class="header">
                <h1>ğŸ”§ ç®¡ç†å‘˜åå°</h1>
                <div class="header-buttons">
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç†åŒºåŸŸ -->
            <div class="query-section">
                <h2 class="section-title">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                
                <div class="action-buttons">
                    <button class="btn-batch" onclick="loadAdminData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    <button class="btn-export" onclick="exportUsersToExcel()">ğŸ“Š å¯¼å‡ºç”¨æˆ·</button>
                    <button class="btn-export" onclick="exportAllLogsToExcel()">ğŸ“œ å¯¼å‡ºæ—¥å¿—</button>
                </div>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>æ‰‹æœºå·</th>
                            <th>ç”¨æˆ·å</th>
                            <th>ä¼šå‘˜ç­‰çº§</th>
                            <th>æ€»é¢åº¦</th>
                            <th>å·²ä½¿ç”¨</th>
                            <th>å‰©ä½™</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTableBody">
                        <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·æ•°æ® -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========================================
             å……å€¼å¼¹çª—
             ======================================== -->
        <div id="rechargeModal" class="recharge-modal">
            <div class="recharge-modal-content">
                <div class="recharge-modal-header">
                    <h2>ğŸ’ å……å€¼é¢åº¦</h2>
                    <button class="modal-close-btn" onclick="closeRechargeModal()">âœ•</button>
                </div>
                
                <div class="recharge-modal-body">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ’°</div>
                        <div style="font-size: 20px; font-weight: 700; color: #333; margin-bottom: 15px;">
                            å……å€¼æœåŠ¡
                        </div>
                        <div style="font-size: 15px; color: #666; line-height: 1.8; margin-bottom: 25px;">
                            å¦‚éœ€å……å€¼æŸ¥è¯¢é¢åº¦ï¼Œè¯·è”ç³»ç®¡ç†å‘˜<br>
                            ç®¡ç†å‘˜å°†ä¸ºæ‚¨æ‰‹åŠ¨æ·»åŠ é¢åº¦
                        </div>
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px;">
                            <div style="font-size: 14px; color: #999; margin-bottom: 10px;">å½“å‰å‰©ä½™é¢åº¦</div>
                            <div style="font-size: 36px; font-weight: 700; color: #667eea;" id="modalRemainQuota">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="recharge-modal-footer">
                    <button class="modal-btn modal-btn-confirm" onclick="closeRechargeModal()">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             ä¿®æ”¹ç”¨æˆ·åå¼¹çª—
             ======================================== -->
        <div id="editNameModal" class="recharge-modal">
            <div class="recharge-modal-content" style="max-width: 450px;">
                <div class="recharge-modal-header">
                    <h2>âœï¸ ä¿®æ”¹ç”¨æˆ·å</h2>
                    <button class="modal-close-btn" onclick="closeEditNameModal()">âœ•</button>
                </div>
                
                <div class="recharge-modal-body">
                    <div class="form-group">
                        <label>å½“å‰ç”¨æˆ·å</label>
                        <input type="text" id="currentUserName" readonly style="background: #f5f5f5; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group">
                        <label>æ–°ç”¨æˆ·å</label>
                        <input type="text" id="newUserName" placeholder="è¯·è¾“å…¥æ–°çš„ç”¨æˆ·åï¼ˆ2-20ä¸ªå­—ç¬¦ï¼‰" maxlength="20">
                    </div>
                    
                    <div class="info-box">
                        <div style="color: #1976d2; font-size: 14px; line-height: 1.6;">
                            <div style="font-weight: 600; margin-bottom: 8px;">ğŸ’¡ æ¸©é¦¨æç¤º</div>
                            <div>â€¢ ç”¨æˆ·åé•¿åº¦ä¸º 2-20 ä¸ªå­—ç¬¦</div>
                            <div>â€¢ å¯ä»¥ä½¿ç”¨ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—</div>
                            <div>â€¢ å»ºè®®ä½¿ç”¨çœŸå®å§“åæˆ–æ˜µç§°</div>
                        </div>
                    </div>
                </div>
                
                <div class="recharge-modal-footer">
                    <button class="modal-btn modal-btn-cancel" onclick="closeEditNameModal()">å–æ¶ˆ</button>
                    <button class="modal-btn modal-btn-confirm" onclick="confirmEditName()">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             åŠ è½½åŠ¨ç”»
             ======================================== -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    <script>
        // ========================================
        // å…¨å±€å˜é‡å£°æ˜
        // ========================================
        let supabaseClient = null;
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let queryRowCounter = 0;
        let queryDataCache = {};
        let historyData = [];
        let filteredHistoryData = [];
        let isSystemInitialized = false;

        // ========================================
        // Supabase é…ç½®ï¼ˆğŸ”´ è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…é…ç½®ï¼‰
        // ========================================
        const SUPABASE_CONFIG = {
            url: 'https://pukyydqtctlvexbndvep.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1a3l5ZHF0Y3RsdmV4Ym5kdmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzQ0MjIsImV4cCI6MjA4MjQxMDQyMn0.1u5yf_3RJWgoJxxMg-CsYZViraJjreMXRH3XBslJaco'
        };

        // é˜¿é‡Œäº‘å¿«é€’æŸ¥è¯¢APIé…ç½®
        const ALIYUN_APPCODE = '8c02c90948e246a994147ed55109955c';

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        // ========================================
        function showLoading(text) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (overlay && loadingText) {
                if (text) loadingText.textContent = text;
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯
        // ========================================
        function showToast(message, type) {
            type = type || 'success';
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(function() {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(function() {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³
        // ========================================
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
        }

        // ========================================
        // è·å–ä¼šå‘˜ç­‰çº§æ–‡æœ¬
        // ========================================
        function getLevelText(level) {
            const levels = {
                'trial': 'è¯•ç”¨è´¦æˆ·',
                'gold': 'é»„é‡‘ä¼šå‘˜',
                'platinum': 'é“‚é‡‘ä¼šå‘˜'
            };
            return levels[level] || level;
        }

        // ========================================
        // ç™»å½•ç•Œé¢ï¼šåˆ‡æ¢æ ‡ç­¾é¡µï¼ˆå¿…é¡»åœ¨æœ€å‰é¢å®šä¹‰ï¼‰
        // ========================================
        function switchLoginTab(type) {
            const userTab = document.querySelector('.tab-btn:first-child');
            const adminTab = document.querySelector('.tab-btn:last-child');
            const userForm = document.getElementById('userLoginForm');
            const adminForm = document.getElementById('adminLoginForm');

            if (type === 'user') {
                userTab.classList.add('active');
                adminTab.classList.remove('active');
                userForm.classList.add('active');
                adminForm.classList.remove('active');
            } else {
                adminTab.classList.add('active');
                userTab.classList.remove('active');
                adminForm.classList.add('active');
                userForm.classList.remove('active');
            }
        }

        // ========================================
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        // ========================================
        function initSupabase() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ğŸ”„ å¼€å§‹åˆå§‹åŒ– Supabase...');
                    
                    // æ£€æŸ¥é…ç½®
                    if (!SUPABASE_CONFIG.url || SUPABASE_CONFIG.url.includes('ä½ çš„é¡¹ç›®ID')) {
                        reject(new Error('è¯·å…ˆé…ç½® Supabase URL'));
                        return;
                    }
                    
                    if (!SUPABASE_CONFIG.key || SUPABASE_CONFIG.key.includes('ä½ çš„anon-publicå¯†é’¥')) {
                        reject(new Error('è¯·å…ˆé…ç½® Supabase Key'));
                        return;
                    }
                    
                    // æ£€æŸ¥ Supabase åº“
                    if (typeof window.supabase === 'undefined') {
                        reject(new Error('Supabase åº“æœªåŠ è½½'));
                        return;
                    }
                    
                    console.log('âœ… Supabase åº“å·²åŠ è½½');
                    
                    // åˆ›å»ºå®¢æˆ·ç«¯
                    supabaseClient = window.supabase.createClient(
                        SUPABASE_CONFIG.url, 
                        SUPABASE_CONFIG.key
                    );
                    
                    if (!supabaseClient) {
                        reject(new Error('Supabase å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥'));
                        return;
                    }
                    
                    console.log('âœ… Supabase å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
                    
                    // æµ‹è¯•è¿æ¥
                    testSupabaseConnection()
                        .then(() => {
                            isSystemInitialized = true;
                            console.log('âœ… Supabase è¿æ¥æµ‹è¯•æˆåŠŸ');
                            resolve(true);
                        })
                        .catch((error) => {
                            console.error('âŒ Supabase è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                            reject(error);
                        });
                    
                } catch (error) {
                    console.error('âŒ Supabase åˆå§‹åŒ–å¼‚å¸¸:', error);
                    reject(error);
                }
            });
        }

        // ========================================
        // æµ‹è¯• Supabase è¿æ¥
        // ========================================
        async function testSupabaseConnection() {
            try {
                console.log('ğŸ” æµ‹è¯• Supabase è¿æ¥...');
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    console.error('âŒ è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                    throw error;
                }
                
                console.log('âœ… è¿æ¥æµ‹è¯•æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸:', error);
                throw error;
            }
        }

        // ========================================
        // æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å·²åˆå§‹åŒ–
        // ========================================
        function checkSystemInit() {
            if (!isSystemInitialized || !supabaseClient) {
                console.error('âŒ ç³»ç»Ÿæœªåˆå§‹åŒ–');
                showToast('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                return false;
            }
            return true;
        }

        // ========================================
        // ç”¨æˆ·ç™»å½•/æ³¨å†Œ
        // ========================================
        async function handleUserLogin() {
            if (!checkSystemInit()) return;
            
            const phone = document.getElementById('loginUserPhone').value.trim();
            
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ç™»å½•...');
                
                const queryResult = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                const existUser = queryResult.data;
                const queryError = queryResult.error;
                
                if (queryError && queryError.code !== 'PGRST116') {
                    throw queryError;
                }
                
                if (!existUser) {
                    const insertResult = await supabaseClient
                        .from('users')
                        .insert([{
                            phone: phone,
                            user_name: 'æ–°ç”¨æˆ·',
                            avatar: 'color-1',
                            level: 'trial',
                            total_quota: 1,
                            used_quota: 0,
                            disabled: false
                        }])
                        .select()
                        .single();
                    
                    if (insertResult.error) throw insertResult.error;
                    
                    currentUser = insertResult.data;
                    hideLoading();
                    showToast('æ³¨å†ŒæˆåŠŸï¼èµ é€1æ¬¡è¯•ç”¨é¢åº¦', 'success');
                } else {
                    if (existUser.disabled) {
                        hideLoading();
                        showToast('è´¦æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                        return;
                    }
                    currentUser = existUser;
                    hideLoading();
                    showToast('ç™»å½•æˆåŠŸï¼', 'success');
                }
                
                authToken = currentUser.id.toString();
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('userInterface').classList.add('active');
                
                updateUserPanel();
                showQuerySection();
                addQueryRow();
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                hideLoading();
                showToast('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ç™»å½•
        // ========================================
        async function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!username || !password) {
                showToast('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }
            
            if (username === 'admin' && password === 'admin123') {
                authToken = 'admin';
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('adminInterface').classList.add('active');
                
                loadAdminData();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
            } else {
                showToast('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
            }
        }

        // ========================================
        // é€€å‡ºç™»å½•
        // ========================================
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            queryDataCache = {};
            historyData = [];
            filteredHistoryData = [];
            
            document.getElementById('userInterface').classList.remove('active');
            document.getElementById('adminInterface').classList.remove('active');
            document.getElementById('unifiedLoginContainer').style.display = 'block';
            
            document.getElementById('loginUserPhone').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('queryTableBody').innerHTML = '';
            queryRowCounter = 0;
            
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        // ========================================
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯é¢æ¿
        // ========================================
        function updateUserPanel() {
            if (!currentUser) return;
            
            document.getElementById('userPhone').textContent = currentUser.phone;
            document.getElementById('userName').textContent = currentUser.user_name || 'æ–°ç”¨æˆ·';
            
            // æ›´æ–°ä¼šå‘˜ç­‰çº§å¾½ç« 
            const levelBadge = document.getElementById('userLevelBadge');
            levelBadge.textContent = getLevelText(currentUser.level);
            levelBadge.className = 'level-badge level-' + currentUser.level;
            
            document.getElementById('totalQuota').textContent = currentUser.total_quota;
            document.getElementById('usedQuota').textContent = currentUser.used_quota;
            document.getElementById('remainQuota').textContent = currentUser.total_quota - currentUser.used_quota;
        }

        // ========================================
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        // ========================================
        async function refreshUserInfo() {
            if (!checkSystemInit()) return;
            if (!authToken || authToken === 'admin') return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', parseInt(authToken))
                    .single();
                
                if (result.error) throw result.error;
                
                currentUser = result.data;
                updateUserPanel();
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            }
        }

        // ========================================
        // å……å€¼åŠŸèƒ½
        // ========================================
        function openRechargeModal() {
            if (currentUser) {
                document.getElementById('modalRemainQuota').textContent = 
                    currentUser.total_quota - currentUser.used_quota;
            }
            document.getElementById('rechargeModal').classList.add('active');
        }

        function closeRechargeModal() {
            document.getElementById('rechargeModal').classList.remove('active');
        }

        // ========================================
        // ç”¨æˆ·ï¼šæ‰“å¼€ä¿®æ”¹ç”¨æˆ·åå¼¹çª—
        // ========================================
        function openEditNameModal() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            document.getElementById('currentUserName').value = currentUser.user_name || 'æ–°ç”¨æˆ·';
            document.getElementById('newUserName').value = '';
            document.getElementById('editNameModal').classList.add('active');
        }

        // ========================================
        // ç”¨æˆ·ï¼šå…³é—­ä¿®æ”¹ç”¨æˆ·åå¼¹çª—
        // ========================================
        function closeEditNameModal() {
            document.getElementById('editNameModal').classList.remove('active');
        }

        // ========================================
        // ç”¨æˆ·ï¼šç¡®è®¤ä¿®æ”¹ç”¨æˆ·å
        // ========================================
        async function confirmEditName() {
            if (!checkSystemInit()) return;
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const newName = document.getElementById('newUserName').value.trim();
            
            if (!newName) {
                showToast('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å', 'error');
                return;
            }
            
            if (newName.length < 2) {
                showToast('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            if (newName.length > 20) {
                showToast('ç”¨æˆ·åæœ€å¤š20ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            if (newName === currentUser.user_name) {
                showToast('æ–°ç”¨æˆ·åä¸å½“å‰ç”¨æˆ·åç›¸åŒ', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ä¿®æ”¹ç”¨æˆ·å...');
                
                const result = await supabaseClient
                    .from('users')
                    .update({ user_name: newName })
                    .eq('id', currentUser.id);
                
                if (result.error) throw result.error;
                
                currentUser.user_name = newName;
                updateUserPanel();
                
                hideLoading();
                closeEditNameModal();
                showToast('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ä¿®æ”¹ç”¨æˆ·åå¤±è´¥:', error);
                hideLoading();
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // åˆ‡æ¢åˆ°æŸ¥è¯¢åŒºåŸŸ
        // ========================================
        function showQuerySection() {
            document.getElementById('querySection').style.display = 'block';
            document.getElementById('historySection').classList.remove('active');
        }

        // ========================================
        // åˆ‡æ¢åˆ°å†å²è®°å½•åŒºåŸŸ
        // ========================================
        async function showHistorySection() {
            document.getElementById('querySection').style.display = 'none';
            document.getElementById('historySection').classList.add('active');
            await loadHistoryData();
        }
        // ========================================
        // å†å²è®°å½•ï¼šåŠ è½½æ•°æ®
        // ========================================
        async function loadHistoryData() {
            if (!checkSystemInit()) return;
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨åŠ è½½å†å²è®°å½•...');
                
                const result = await supabaseClient
                    .from('query_logs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                historyData = result.data || [];
                filteredHistoryData = historyData;
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                const totalCount = historyData.length;
                const successCount = historyData.filter(item => item.status === 'success').length;
                const failedCount = historyData.filter(item => item.status === 'failed').length;
                
                document.getElementById('historyTotalCount').textContent = totalCount;
                document.getElementById('historySuccessCount').textContent = successCount;
                document.getElementById('historyFailedCount').textContent = failedCount;
                
                // æ¸²æŸ“è¡¨æ ¼
                renderHistoryTable();
                
                hideLoading();
                
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                hideLoading();
                showToast('åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•ï¼šæ¸²æŸ“è¡¨æ ¼
        // ========================================
        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (filteredHistoryData.length === 0) {
                tbody.innerHTML = '<tr>' +
                    '<td colspan="7">' +
                    '<div class="history-empty">' +
                    '<div class="history-empty-icon">ğŸ“­</div>' +
                    '<div class="history-empty-text">æš‚æ— æŸ¥è¯¢è®°å½•</div>' +
                    '<div class="history-empty-hint">å¿«å»æŸ¥è¯¢ä¸€äº›å¿«é€’å§ï¼</div>' +
                    '</div>' +
                    '</td>' +
                    '</tr>';
                return;
            }
            
            for (let i = 0; i < filteredHistoryData.length; i++) {
                const item = filteredHistoryData[i];
                const row = document.createElement('tr');
                
                row.innerHTML = '<td>' + formatDate(item.query_time || item.created_at) + '</td>' +
                    '<td>' + (item.express_number || '-') + '</td>' +
                    '<td>' + (item.mobile || '-') + '</td>' +
                    '<td>' + (item.company_name || '-') + '</td>' +
                    '<td>' + (item.express_status || '-') + '</td>' +
                    '<td>' +
                    '<span class="query-status-badge query-status-' + item.status + '">' +
                    (item.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥') +
                    '</span>' +
                    '</td>' +
                    '<td>' +
                    (item.status === 'success' && item.logistics_data ? 
                        '<button class="btn-query btn-detail" onclick="showHistoryDetail(' + i + ')">è¯¦æƒ…</button>' : '') +
                    '<button class="btn-query btn-requery" onclick="requeryFromHistory(' + i + ')">å†æ¬¡æŸ¥è¯¢</button>' +
                    '<button class="btn-query btn-delete" onclick="deleteHistoryItem(' + i + ')">åˆ é™¤</button>' +
                    '</td>';
                
                tbody.appendChild(row);
            }
        }

        // ========================================
        // å†å²è®°å½•ï¼šç­›é€‰
        // ========================================
        function filterHistory() {
            const expressNumber = document.getElementById('filterExpressNumber').value.trim().toLowerCase();
            const company = document.getElementById('filterCompany').value.trim().toLowerCase();
            const status = document.getElementById('filterStatus').value;
            
            filteredHistoryData = historyData.filter(function(item) {
                let match = true;
                
                if (expressNumber && (!item.express_number || item.express_number.toLowerCase().indexOf(expressNumber) === -1)) {
                    match = false;
                }
                
                if (company && (!item.company_name || item.company_name.toLowerCase().indexOf(company) === -1)) {
                    match = false;
                }
                
                if (status && item.status !== status) {
                    match = false;
                }
                
                return match;
            });
            
            renderHistoryTable();
            showToast('ç­›é€‰å®Œæˆï¼Œå…± ' + filteredHistoryData.length + ' æ¡è®°å½•', 'success');
        }

        // ========================================
        // å†å²è®°å½•ï¼šæ˜¾ç¤ºè¯¦æƒ…
        // ========================================
        function showHistoryDetail(index) {
            const item = filteredHistoryData[index];
            
            if (!item.logistics_data) {
                showToast('æš‚æ— ç‰©æµè¯¦æƒ…', 'error');
                return;
            }
            
            try {
                const logisticsData = typeof item.logistics_data === 'string' ? 
                    JSON.parse(item.logistics_data) : item.logistics_data;
                
                // åˆ›å»ºè¯¦æƒ…å±•ç¤ºè¡Œ
                const tbody = document.getElementById('historyTableBody');
                const currentRow = tbody.rows[index];
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å±•å¼€
                if (currentRow.nextSibling && currentRow.nextSibling.classList && 
                    currentRow.nextSibling.classList.contains('logistics-detail-row')) {
                    tbody.removeChild(currentRow.nextSibling);
                    return;
                }
                
                const detailRow = document.createElement('tr');
                detailRow.className = 'logistics-detail-row';
                
                let detailHTML = '<td colspan="7">' +
                    '<div class="logistics-details">' +
                    '<div class="logistics-header">' +
                    '<div>' +
                    '<div class="logistics-title">ğŸ“¦ ç‰©æµè¯¦æƒ…</div>';
                
                if (logisticsData.company_logo) {
                    detailHTML += '<div class="logistics-company">' +
                        '<img src="' + logisticsData.company_logo + '" class="company-logo" alt="logo">' +
                        '<span class="company-name">' + (logisticsData.company || '') + '</span>' +
                        '</div>';
                } else {
                    detailHTML += '<div class="logistics-company">' +
                        '<span class="company-name">' + (logisticsData.company || '') + '</span>' +
                        '</div>';
                }
                
                detailHTML += '<div class="logistics-meta">å¿«é€’å•å·ï¼š' + (logisticsData.express_number || '') + '</div>';
                
                if (logisticsData.courier || logisticsData.courier_phone) {
                    detailHTML += '<div class="logistics-meta courier-info">' +
                        'å¿«é€’å‘˜ï¼š' + (logisticsData.courier || '') + 
                        (logisticsData.courier_phone ? ' (' + logisticsData.courier_phone + ')' : '') +
                        '</div>';
                }
                
                detailHTML += '</div>' +
                    '<div>' +
                    '<span class="express-status status-' + logisticsData.status_code + '">' + 
                    (logisticsData.status || '') + '</span>' +
                    '</div>' +
                    '</div>';
                
                // åŸºæœ¬ä¿¡æ¯
                detailHTML += '<div class="logistics-info-box">' +
                    '<div class="info-row">' +
                    '<span class="info-label">æœ€æ–°çŠ¶æ€ï¼š</span>' +
                    '<span class="info-value">' + (logisticsData.latest_message || '-') + '</span>' +
                    '</div>' +
                    '<div class="info-row">' +
                    '<span class="info-label">æœ€æ–°æ—¶é—´ï¼š</span>' +
                    '<span class="info-value">' + (logisticsData.latest_time || '-') + '</span>' +
                    '</div>';
                
                if (logisticsData.take_time) {
                    detailHTML += '<div class="info-row">' +
                        '<span class="info-label">é…é€è€—æ—¶ï¼š</span>' +
                        '<span class="info-value">' + logisticsData.take_time + '</span>' +
                        '</div>';
                }
                
                detailHTML += '</div>';
                
                // ç‰©æµè½¨è¿¹
                detailHTML += '<div class="logistics-timeline">' +
                    '<div class="timeline-title">ğŸšš ç‰©æµè½¨è¿¹</div>';
                
                const logisticsList = logisticsData.list || logisticsData.data || [];
                
                if (logisticsList && logisticsList.length > 0) {
                    for (let j = 0; j < logisticsList.length; j++) {
                        const trace = logisticsList[j];
                        detailHTML += '<div class="logistics-item">' +
                            '<div class="logistics-time">' + (trace.time || '') + '</div>' +
                            '<div class="logistics-content">' +
                            (trace.status || trace.context || trace.desc || '') +
                            (trace.location || trace.area || trace.areaName ? 
                                '<div class="logistics-area">ğŸ“ ' + (trace.location || trace.area || trace.areaName) + '</div>' : '') +
                            '</div>' +
                            '</div>';
                    }
                } else {
                    detailHTML += '<div class="logistics-empty">æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯</div>';
                }
                
                detailHTML += '</div>' +
                    '</div>' +
                    '</td>';
                
                detailRow.innerHTML = detailHTML;
                
                // æ’å…¥åˆ°å½“å‰è¡Œåé¢
                if (currentRow.nextSibling) {
                    tbody.insertBefore(detailRow, currentRow.nextSibling);
                } else {
                    tbody.appendChild(detailRow);
                }
                
            } catch (error) {
                console.error('æ˜¾ç¤ºè¯¦æƒ…å¤±è´¥:', error);
                showToast('æ˜¾ç¤ºè¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•ï¼šå†æ¬¡æŸ¥è¯¢ï¼ˆç»ˆæä¿®å¤ç‰ˆï¼‰
        // ========================================
        async function requeryFromHistory(index) {
            const item = filteredHistoryData[index];
            
            if (!item || !item.express_number) {
                showToast('å¿«é€’å•å·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            if (currentUser.total_quota - currentUser.used_quota <= 0) {
                showToast('æŸ¥è¯¢é¢åº¦ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•', 'error');
                openRechargeModal();
                return;
            }
            
            if (!confirm('ç¡®å®šè¦å†æ¬¡æŸ¥è¯¢å¿«é€’å•å· ' + item.express_number + ' å—ï¼Ÿ\nå°†æ¶ˆè€—1æ¬¡æŸ¥è¯¢é¢åº¦')) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨æŸ¥è¯¢ä¸­...');
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ” å†æ¬¡æŸ¥è¯¢å¿«é€’');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('å¿«é€’å•å·:', item.express_number);
                console.log('æ‰‹æœºå·:', item.mobile || 'æ— ');
                
                // æ£€æŸ¥ AppCode é…ç½®
                if (!ALIYUN_APPCODE || ALIYUN_APPCODE.includes('ä½ çš„AppCode')) {
                    hideLoading();
                    throw new Error('è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½®é˜¿é‡Œäº‘ AppCode');
                }
                
                // æ„å»ºè¯·æ±‚å‚æ•°
                const formData = new URLSearchParams();
                formData.append('number', item.express_number);
                if (item.mobile) {
                    formData.append('mobile', item.mobile);
                }
                
                console.log('ğŸ“¤ å‘é€è¯·æ±‚...');
                
                // å‘é€è¯·æ±‚
                const response = await fetch('https://jmexpresv2.market.alicloudapi.com/express/query-v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'APPCODE ' + ALIYUN_APPCODE,
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: formData.toString()
                });
                
                console.log('ğŸ“¥ æ”¶åˆ°å“åº”');
                console.log('çŠ¶æ€ç :', response.status);
                
                // æ£€æŸ¥ HTTP çŠ¶æ€ç 
                if (!response.ok) {
                    hideLoading();
                    
                    let errorMsg = '';
                    if (response.status === 401 || response.status === 403) {
                        errorMsg = 'AppCode è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
                    } else if (response.status === 429) {
                        errorMsg = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                    } else {
                        errorMsg = 'HTTPé”™è¯¯: ' + response.status;
                    }
                    
                    throw new Error(errorMsg);
                }
                
                // è·å–å“åº”æ–‡æœ¬
                const responseText = await response.text();
                console.log('ğŸ“„ å“åº”å†…å®¹é•¿åº¦:', responseText.length);
                console.log('ğŸ“„ å“åº”å†…å®¹é¢„è§ˆ:', responseText.substring(0, 200));
                
                // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
                if (!responseText || responseText.trim() === '') {
                    hideLoading();
                    throw new Error('API è¿”å›ç©ºå“åº”ï¼Œè¯·æ£€æŸ¥ AppCode æ˜¯å¦æ­£ç¡®');
                }
                
                // å°è¯•è§£æ JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('âœ… JSON è§£ææˆåŠŸ');
                } catch (jsonError) {
                    console.error('âŒ JSON è§£æå¤±è´¥');
                    console.error('åŸå§‹å“åº”:', responseText);
                    hideLoading();
                    
                    if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        throw new Error('API è¿”å›äº† HTML é¡µé¢ï¼ŒAppCode å¯èƒ½é”™è¯¯');
                    }
                    
                    throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');
                }
                
                // å¤„ç†æŸ¥è¯¢ç»“æœ
                if (result.code === 200 && result.data) {
                    console.log('âœ… æŸ¥è¯¢æˆåŠŸ');
                    const data = result.data;
                    
                    const unifiedData = {
                        express_number: data.number,
                        company: data.expressCompanyName,
                        company_code: data.expressCode,
                        company_logo: data.expressCompanyLogo,
                        status: data.logisticsStatusDesc,
                        status_code: data.logisticsStatus,
                        latest_message: data.theLastMessage,
                        latest_time: data.theLastTime,
                        take_time: data.takeTime,
                        courier: data.courier,
                        courier_phone: data.courierPhone,
                        list: []
                    };
                    
                    if (data.logisticsTraceDetails && data.logisticsTraceDetails.length > 0) {
                        unifiedData.list = data.logisticsTraceDetails.map(function(item) {
                            return {
                                time: formatTimestamp(item.time),
                                status: item.desc,
                                context: item.desc,
                                location: item.areaName || '',
                                area: item.areaName || '',
                                status_code: item.logisticsStatus,
                                sub_status_code: item.subLogisticsStatus
                            };
                        });
                    }
                    
                    await updateUserQuota();
                    await logQuery(
                        item.express_number,
                        item.mobile || '',
                        data.expressCompanyName,
                        'success',
                        data.logisticsStatusDesc,
                        unifiedData
                    );
                    
                    hideLoading();
                    showToast('æŸ¥è¯¢æˆåŠŸï¼', 'success');
                    await loadHistoryData();
                    
                } else {
                    hideLoading();
                    const errorMsg = result.msg || 'æœªçŸ¥é”™è¯¯';
                    showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + errorMsg, 'error');
                    await logQuery(item.express_number, item.mobile || '', '', 'failed', errorMsg, null);
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… æŸ¥è¯¢æµç¨‹å®Œæˆ');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ å†æ¬¡æŸ¥è¯¢å¤±è´¥');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('é”™è¯¯:', error);
                
                hideLoading();
                
                let errorMsg = 'æŸ¥è¯¢å¤±è´¥ï¼š';
                if (error.message.includes('AppCode')) {
                    errorMsg += '\nè¯·æ£€æŸ¥é˜¿é‡Œäº‘ AppCode é…ç½®';
                } else if (error.message.includes('è®¤è¯')) {
                    errorMsg += '\nAppCode è®¤è¯å¤±è´¥';
                } else {
                    errorMsg += '\n' + error.message;
                }
                
                showToast(errorMsg, 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•ï¼šåˆ é™¤å•æ¡è®°å½•
        // ========================================
        async function deleteHistoryItem(index) {
            if (!checkSystemInit()) return;
            
            const item = filteredHistoryData[index];
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æŸ¥è¯¢è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨åˆ é™¤...');
                
                const result = await supabaseClient
                    .from('query_logs')
                    .delete()
                    .eq('id', item.id);
                
                if (result.error) throw result.error;
                
                hideLoading();
                showToast('åˆ é™¤æˆåŠŸï¼', 'success');
                await loadHistoryData();
                
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                hideLoading();
                showToast('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        // ========================================
        // æŸ¥è¯¢ï¼šæ·»åŠ æŸ¥è¯¢è¡Œ
        // ========================================
        function addQueryRow() {
            queryRowCounter++;
            const tbody = document.getElementById('queryTableBody');
            const row = document.createElement('tr');
            row.id = 'queryRow-' + queryRowCounter;
            
            row.innerHTML = '<td>' +
                '<input type="text" id="expressNumber-' + queryRowCounter + '" placeholder="è¯·è¾“å…¥å¿«é€’å•å·" />' +
                '</td>' +
                '<td>' +
                '<input type="text" id="mobile-' + queryRowCounter + '" placeholder="é€‰å¡«" maxlength="4" />' +
                '</td>' +
                '<td>' +
                '<span class="query-status-badge query-status-pending">å¾…æŸ¥è¯¢</span>' +
                '</td>' +
                '<td>-</td>' +
                '<td>-</td>' +
                '<td>' +
                '<button class="btn-query" onclick="querySingleExpress(' + queryRowCounter + ')">æŸ¥è¯¢</button>' +
                '<button class="btn-query btn-delete" onclick="deleteQueryRow(' + queryRowCounter + ')">åˆ é™¤</button>' +
                '</td>';
            
            tbody.appendChild(row);
        }

        // ========================================
        // æŸ¥è¯¢ï¼šåˆ é™¤æŸ¥è¯¢è¡Œ
        // ========================================
        function deleteQueryRow(rowId) {
            const row = document.getElementById('queryRow-' + rowId);
            if (row) {
                row.remove();
                delete queryDataCache[rowId];
            }
        }

        // ========================================
        // æŸ¥è¯¢ï¼šæ¸…ç©ºæ‰€æœ‰è¡Œ
        // ========================================
        function clearAllRows() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è¡Œå—ï¼Ÿ')) {
                return;
            }
            
            document.getElementById('queryTableBody').innerHTML = '';
            queryDataCache = {};
            queryRowCounter = 0;
            showToast('å·²æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è¡Œ', 'success');
        }

        // ========================================
        // æŸ¥è¯¢ï¼šå•ä¸ªæŸ¥è¯¢ï¼ˆç»ˆæä¿®å¤ç‰ˆï¼‰
        // ========================================
        async function querySingleExpress(rowId) {
            const expressNumber = document.getElementById('expressNumber-' + rowId).value.trim();
            const mobile = document.getElementById('mobile-' + rowId).value.trim();
            
            if (!expressNumber) {
                showToast('è¯·è¾“å…¥å¿«é€’å•å·', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            if (currentUser.total_quota - currentUser.used_quota <= 0) {
                showToast('æŸ¥è¯¢é¢åº¦ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•', 'error');
                openRechargeModal();
                return;
            }
            
            const row = document.getElementById('queryRow-' + rowId);
            if (!row) {
                console.error('æ‰¾ä¸åˆ°è¡Œ:', rowId);
                return;
            }
            
            const statusCell = row.cells[2];
            const expressStatusCell = row.cells[3];
            const companyCell = row.cells[4];
            const actionCell = row.cells[5];
            
            statusCell.innerHTML = '<span class="query-status-badge query-status-querying">æŸ¥è¯¢ä¸­...</span>';
            
            try {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ” å¼€å§‹æŸ¥è¯¢å¿«é€’');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('å¿«é€’å•å·:', expressNumber);
                console.log('æ‰‹æœºå·:', mobile || 'æ— ');
                
                // æ£€æŸ¥ AppCode é…ç½®
                if (!ALIYUN_APPCODE || ALIYUN_APPCODE.includes('ä½ çš„AppCode')) {
                    throw new Error('è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½®é˜¿é‡Œäº‘ AppCode');
                }
                
                console.log('AppCode å‰10ä½:', ALIYUN_APPCODE.substring(0, 10) + '...');
                
                // æ„å»ºè¯·æ±‚å‚æ•°
                const formData = new URLSearchParams();
                formData.append('number', expressNumber);
                if (mobile) {
                    formData.append('mobile', mobile);
                }
                
                console.log('ğŸ“¤ å‘é€è¯·æ±‚...');
                
                // å‘é€è¯·æ±‚
                const response = await fetch('https://jmexpresv2.market.alicloudapi.com/express/query-v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'APPCODE ' + ALIYUN_APPCODE,
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: formData.toString()
                });
                
                console.log('ğŸ“¥ æ”¶åˆ°å“åº”');
                console.log('çŠ¶æ€ç :', response.status);
                console.log('çŠ¶æ€æ–‡æœ¬:', response.statusText);
                console.log('Content-Type:', response.headers.get('content-type'));
                
                // æ£€æŸ¥ HTTP çŠ¶æ€ç 
                if (!response.ok) {
                    let errorMsg = '';
                    
                    if (response.status === 400) {
                        errorMsg = 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥å¿«é€’å•å·æ ¼å¼';
                    } else if (response.status === 401) {
                        errorMsg = 'AppCode è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ AppCode æ˜¯å¦æ­£ç¡®';
                    } else if (response.status === 403) {
                        errorMsg = 'API è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥ AppCode æƒé™æˆ–æ˜¯å¦æ¬ è´¹';
                    } else if (response.status === 404) {
                        errorMsg = 'API æ¥å£ä¸å­˜åœ¨';
                    } else if (response.status === 429) {
                        errorMsg = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                    } else if (response.status >= 500) {
                        errorMsg = 'æœåŠ¡å™¨é”™è¯¯(' + response.status + ')ï¼Œè¯·ç¨åå†è¯•';
                    } else {
                        errorMsg = 'HTTPé”™è¯¯: ' + response.status;
                    }
                    
                    console.error('âŒ HTTPé”™è¯¯:', errorMsg);
                    throw new Error(errorMsg);
                }
                
                // è·å–å“åº”æ–‡æœ¬
                const responseText = await response.text();
                console.log('ğŸ“„ å“åº”å†…å®¹é•¿åº¦:', responseText.length);
                console.log('ğŸ“„ å“åº”å†…å®¹é¢„è§ˆ:', responseText.substring(0, 500));
                
                // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
                if (!responseText || responseText.trim() === '') {
                    console.error('âŒ å“åº”ä¸ºç©º');
                    throw new Error('API è¿”å›ç©ºå“åº”ï¼Œè¯·æ£€æŸ¥ AppCode æ˜¯å¦æ­£ç¡®æˆ–æ˜¯å¦æ¬ è´¹');
                }
                
                // å°è¯•è§£æ JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('âœ… JSON è§£ææˆåŠŸ');
                    console.log('è¿”å›æ•°æ®:', result);
                } catch (jsonError) {
                    console.error('âŒ JSON è§£æå¤±è´¥');
                    console.error('JSON é”™è¯¯:', jsonError.message);
                    console.error('åŸå§‹å“åº”:', responseText);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ HTML é”™è¯¯é¡µé¢
                    if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        throw new Error('API è¿”å›äº† HTML é¡µé¢ï¼Œå¯èƒ½æ˜¯ AppCode é”™è¯¯æˆ–æœåŠ¡å¼‚å¸¸');
                    }
                    
                    throw new Error('API è¿”å›æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æ JSON');
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“Š å¤„ç†æŸ¥è¯¢ç»“æœ');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('è¿”å›ç :', result.code);
                console.log('è¿”å›æ¶ˆæ¯:', result.msg);
                
                // å¤„ç†æŸ¥è¯¢ç»“æœ
                if (result.code === 200 && result.data) {
                    console.log('âœ… æŸ¥è¯¢æˆåŠŸ');
                    const data = result.data;
                    
                    const unifiedData = {
                        express_number: data.number,
                        company: data.expressCompanyName,
                        company_code: data.expressCode,
                        company_logo: data.expressCompanyLogo,
                        status: data.logisticsStatusDesc,
                        status_code: data.logisticsStatus,
                        latest_message: data.theLastMessage,
                        latest_time: data.theLastTime,
                        take_time: data.takeTime,
                        courier: data.courier,
                        courier_phone: data.courierPhone,
                        list: []
                    };
                    
                    if (data.logisticsTraceDetails && data.logisticsTraceDetails.length > 0) {
                        unifiedData.list = data.logisticsTraceDetails.map(function(item) {
                            return {
                                time: formatTimestamp(item.time),
                                status: item.desc,
                                context: item.desc,
                                location: item.areaName || '',
                                area: item.areaName || '',
                                status_code: item.logisticsStatus,
                                sub_status_code: item.subLogisticsStatus
                            };
                        });
                    }
                    
                    queryDataCache[rowId] = unifiedData;
                    
                    statusCell.innerHTML = '<span class="query-status-badge query-status-success">æŸ¥è¯¢æˆåŠŸ</span>';
                    expressStatusCell.innerHTML = '<span class="express-status status-' + data.logisticsStatus + '">' + data.logisticsStatusDesc + '</span>';
                    companyCell.innerHTML = '<div style="display: flex; align-items: center; gap: 8px;">' +
                        (data.expressCompanyLogo ? '<img src="' + data.expressCompanyLogo + '" style="width: 20px; height: 20px; object-fit: contain;" alt="logo">' : '') +
                        '<span>' + data.expressCompanyName + '</span>' +
                        '</div>';
                    
                    actionCell.innerHTML = 
                        '<button class="btn-query btn-detail" onclick="showLogisticsDetail(' + rowId + ')">è¯¦æƒ…</button>' +
                        '<button class="btn-query btn-delete" onclick="deleteQueryRow(' + rowId + ')">åˆ é™¤</button>';
                    
                    await updateUserQuota();
                    await logQuery(expressNumber, mobile, data.expressCompanyName, 'success', data.logisticsStatusDesc, unifiedData);
                    
                    showToast('æŸ¥è¯¢æˆåŠŸï¼', 'success');
                    
                } else if (result.code === 201) {
                    console.log('âš ï¸ æš‚æ— ç‰©æµä¿¡æ¯');
                    statusCell.innerHTML = '<span class="query-status-badge query-status-failed">æš‚æ— è®°å½•</span>';
                    expressStatusCell.textContent = 'æš‚æ— ç‰©æµä¿¡æ¯';
                    companyCell.textContent = '-';
                    
                    await logQuery(expressNumber, mobile, '', 'failed', 'æš‚æ— è®°å½•', null);
                    showToast('æš‚æ— ç‰©æµä¿¡æ¯', 'error');
                    
                } else if (result.code === 203) {
                    console.log('âš ï¸ å¿«é€’å•å·é”™è¯¯');
                    statusCell.innerHTML = '<span class="query-status-badge query-status-failed">å•å·é”™è¯¯</span>';
                    expressStatusCell.textContent = 'å¿«é€’å•å·æ ¼å¼é”™è¯¯';
                    companyCell.textContent = '-';
                    
                    await logQuery(expressNumber, mobile, '', 'failed', 'å•å·é”™è¯¯', null);
                    showToast('å¿«é€’å•å·æ ¼å¼é”™è¯¯', 'error');
                    
                } else if (result.code === 204) {
                    console.log('âš ï¸ æ— æ³•è¯†åˆ«å¿«é€’å…¬å¸');
                    statusCell.innerHTML = '<span class="query-status-badge query-status-failed">è¯†åˆ«å¤±è´¥</span>';
                    expressStatusCell.textContent = 'æ— æ³•è¯†åˆ«å¿«é€’å…¬å¸';
                    companyCell.textContent = '-';
                    
                    await logQuery(expressNumber, mobile, '', 'failed', 'è¯†åˆ«å¤±è´¥', null);
                    showToast('æ— æ³•è¯†åˆ«å¿«é€’å…¬å¸ï¼Œè¯·æ£€æŸ¥å•å·', 'error');
                    
                } else {
                    console.log('âš ï¸ å…¶ä»–é”™è¯¯');
                    statusCell.innerHTML = '<span class="query-status-badge query-status-failed">æŸ¥è¯¢å¤±è´¥</span>';
                    expressStatusCell.textContent = result.msg || 'æŸ¥è¯¢å¤±è´¥';
                    companyCell.textContent = '-';
                    
                    await logQuery(expressNumber, mobile, '', 'failed', result.msg || '', null);
                    showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… æŸ¥è¯¢æµç¨‹å®Œæˆ');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ æŸ¥è¯¢å¤±è´¥');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('é”™è¯¯ç±»å‹:', error.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                
                statusCell.innerHTML = '<span class="query-status-badge query-status-failed">æŸ¥è¯¢å¤±è´¥</span>';
                expressStatusCell.textContent = error.message || 'ç½‘ç»œé”™è¯¯';
                companyCell.textContent = '-';
                
                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                let errorMsg = 'æŸ¥è¯¢å¤±è´¥ï¼š';
                if (error.message.includes('AppCode')) {
                    errorMsg += '\nè¯·æ£€æŸ¥é˜¿é‡Œäº‘ AppCode é…ç½®';
                } else if (error.message.includes('è®¤è¯')) {
                    errorMsg += '\nAppCode è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®';
                } else if (error.message.includes('æ¬ è´¹')) {
                    errorMsg += '\nå¯èƒ½æ˜¯ API æœåŠ¡æ¬ è´¹';
                } else if (error.message.includes('ç½‘ç»œ')) {
                    errorMsg += '\nç½‘ç»œè¿æ¥å¤±è´¥';
                } else {
                    errorMsg += '\n' + error.message;
                }
                
                showToast(errorMsg, 'error');
            }
        }

        // ========================================
        // æŸ¥è¯¢ï¼šæ‰¹é‡æŸ¥è¯¢
        // ========================================
        async function batchQuery() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const tbody = document.getElementById('queryTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 0) {
                showToast('è¯·å…ˆæ·»åŠ æŸ¥è¯¢è¡Œ', 'error');
                return;
            }
            
            // æ”¶é›†å¾…æŸ¥è¯¢çš„è¡Œ
            const queryRows = [];
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowId = row.id.replace('queryRow-', '');
                const expressNumber = document.getElementById('expressNumber-' + rowId).value.trim();
                
                if (expressNumber) {
                    const statusCell = row.cells[2];
                    const statusText = statusCell.textContent;
                    
                    // åªæŸ¥è¯¢å¾…æŸ¥è¯¢å’ŒæŸ¥è¯¢å¤±è´¥çš„
                    if (statusText.includes('å¾…æŸ¥è¯¢') || statusText.includes('æŸ¥è¯¢å¤±è´¥')) {
                        queryRows.push(rowId);
                    }
                }
            }
            
            if (queryRows.length === 0) {
                showToast('æ²¡æœ‰éœ€è¦æŸ¥è¯¢çš„å•å·', 'error');
                return;
            }
            
            const remainQuota = currentUser.total_quota - currentUser.used_quota;
            if (remainQuota < queryRows.length) {
                showToast('å‰©ä½™é¢åº¦ä¸è¶³ï¼Œéœ€è¦ ' + queryRows.length + ' æ¬¡ï¼Œå‰©ä½™ ' + remainQuota + ' æ¬¡', 'error');
                openRechargeModal();
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ‰¹é‡æŸ¥è¯¢ ' + queryRows.length + ' ä¸ªå¿«é€’å—ï¼Ÿ\nå°†æ¶ˆè€— ' + queryRows.length + ' æ¬¡æŸ¥è¯¢é¢åº¦')) {
                return;
            }
            
            showLoading('æ­£åœ¨æ‰¹é‡æŸ¥è¯¢ä¸­...');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < queryRows.length; i++) {
                try {
                    await querySingleExpress(queryRows[i]);
                    successCount++;
                    await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿ500msé¿å…è¯·æ±‚è¿‡å¿«
                } catch (error) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', error);
                    failCount++;
                }
            }
            
            hideLoading();
            showToast('æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼æˆåŠŸ ' + successCount + ' ä¸ªï¼Œå¤±è´¥ ' + failCount + ' ä¸ª', 'success');
        }

        // ========================================
        // æŸ¥è¯¢ï¼šæ˜¾ç¤ºç‰©æµè¯¦æƒ…
        // ========================================
        function showLogisticsDetail(rowId) {
            const logisticsData = queryDataCache[rowId];
            
            if (!logisticsData) {
                showToast('æš‚æ— ç‰©æµè¯¦æƒ…', 'error');
                return;
            }
            
            const tbody = document.getElementById('queryTableBody');
            const currentRow = document.getElementById('queryRow-' + rowId);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å±•å¼€
            if (currentRow.nextSibling && currentRow.nextSibling.classList && 
                currentRow.nextSibling.classList.contains('logistics-detail-row')) {
                tbody.removeChild(currentRow.nextSibling);
                return;
            }
            
            const detailRow = document.createElement('tr');
            detailRow.className = 'logistics-detail-row';
            
            let detailHTML = '<td colspan="6">' +
                '<div class="logistics-details">' +
                '<div class="logistics-header">' +
                '<div>' +
                '<div class="logistics-title">ğŸ“¦ ç‰©æµè¯¦æƒ…</div>';
            
            if (logisticsData.company_logo) {
                detailHTML += '<div class="logistics-company">' +
                    '<img src="' + logisticsData.company_logo + '" class="company-logo" alt="logo">' +
                    '<span class="company-name">' + logisticsData.company + '</span>' +
                    '</div>';
            } else {
                detailHTML += '<div class="logistics-company">' +
                    '<span class="company-name">' + logisticsData.company + '</span>' +
                    '</div>';
            }
            
            detailHTML += '<div class="logistics-meta">å¿«é€’å•å·ï¼š' + logisticsData.express_number + '</div>';
            
            if (logisticsData.courier || logisticsData.courier_phone) {
                detailHTML += '<div class="logistics-meta courier-info">' +
                    'å¿«é€’å‘˜ï¼š' + (logisticsData.courier || '') + 
                    (logisticsData.courier_phone ? ' (' + logisticsData.courier_phone + ')' : '') +
                    '</div>';
            }
            
            detailHTML += '</div>' +
                '<div>' +
                '<span class="express-status status-' + logisticsData.status_code + '">' + logisticsData.status + '</span>' +
                '</div>' +
                '</div>';
            
            // åŸºæœ¬ä¿¡æ¯
            detailHTML += '<div class="logistics-info-box">' +
                '<div class="info-row">' +
                '<span class="info-label">æœ€æ–°çŠ¶æ€ï¼š</span>' +
                '<span class="info-value">' + (logisticsData.latest_message || '-') + '</span>' +
                '</div>' +
                '<div class="info-row">' +
                '<span class="info-label">æœ€æ–°æ—¶é—´ï¼š</span>' +
                '<span class="info-value">' + (logisticsData.latest_time || '-') + '</span>' +
                '</div>';
            
            if (logisticsData.take_time) {
                detailHTML += '<div class="info-row">' +
                    '<span class="info-label">é…é€è€—æ—¶ï¼š</span>' +
                    '<span class="info-value">' + logisticsData.take_time + '</span>' +
                    '</div>';
            }
            
            detailHTML += '</div>';
            
            // ç‰©æµè½¨è¿¹
            detailHTML += '<div class="logistics-timeline">' +
                '<div class="timeline-title">ğŸšš ç‰©æµè½¨è¿¹</div>';
            
            if (logisticsData.list && logisticsData.list.length > 0) {
                for (let i = 0; i < logisticsData.list.length; i++) {
                    const trace = logisticsData.list[i];
                    detailHTML += '<div class="logistics-item">' +
                        '<div class="logistics-time">' + trace.time + '</div>' +
                        '<div class="logistics-content">' +
                        trace.status +
                        (trace.location ? '<div class="logistics-area">ğŸ“ ' + trace.location + '</div>' : '') +
                        '</div>' +
                        '</div>';
                }
            } else {
                detailHTML += '<div class="logistics-empty">æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯</div>';
            }
            
            detailHTML += '</div>' +
                '</div>' +
                '</td>';
            
            detailRow.innerHTML = detailHTML;
            
            // æ’å…¥åˆ°å½“å‰è¡Œåé¢
            if (currentRow.nextSibling) {
                tbody.insertBefore(detailRow, currentRow.nextSibling);
            } else {
                tbody.appendChild(detailRow);
            }
        }
        // ========================================
        // æ›´æ–°ç”¨æˆ·æŸ¥è¯¢é¢åº¦
        // ========================================
        async function updateUserQuota() {
            if (!checkSystemInit()) return;
            if (!currentUser) return;
            
            try {
                const newUsedQuota = currentUser.used_quota + 1;
                
                const result = await supabaseClient
                    .from('users')
                    .update({ used_quota: newUsedQuota })
                    .eq('id', currentUser.id);
                
                if (result.error) throw result.error;
                
                currentUser.used_quota = newUsedQuota;
                updateUserPanel();
                
            } catch (error) {
                console.error('æ›´æ–°é¢åº¦å¤±è´¥:', error);
            }
        }

        // ========================================
        // è®°å½•æŸ¥è¯¢æ—¥å¿—
        // ========================================
        async function logQuery(expressNumber, mobile, companyName, status, expressStatus, logisticsData) {
            if (!checkSystemInit()) return;
            if (!currentUser) return;
            
            try {
                const logData = {
                    user_id: currentUser.id,
                    express_number: expressNumber,
                    mobile: mobile || null,
                    company_name: companyName || null,
                    status: status,
                    express_status: expressStatus || null,
                    logistics_data: logisticsData ? JSON.stringify(logisticsData) : null,
                    query_time: new Date().toISOString()
                };
                
                const result = await supabaseClient
                    .from('query_logs')
                    .insert([logData]);
                
                if (result.error) throw result.error;
                
            } catch (error) {
                console.error('è®°å½•æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåŠ è½½æ‰€æœ‰ç”¨æˆ·
        // ========================================
        async function loadAdminData() {
            if (!checkSystemInit()) return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const users = result.data;
                const tbody = document.getElementById('adminUsersTableBody');
                tbody.innerHTML = '';
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr>' +
                        '<td colspan="8" style="text-align: center; padding: 40px; color: #999;">' +
                        'æš‚æ— ç”¨æˆ·æ•°æ®' +
                        '</td>' +
                        '</tr>';
                    return;
                }
                
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    const row = document.createElement('tr');
                    
                    // ä¼šå‘˜ç­‰çº§é€‰æ‹©å™¨
                    const levelSelect = '<select class="level-select" data-old-level="' + user.level + '" ' +
                        'onchange="changeUserLevel(' + user.id + ', this)">' +
                        '<option value="trial" ' + (user.level === 'trial' ? 'selected' : '') + '>è¯•ç”¨è´¦æˆ·</option>' +
                        '<option value="gold" ' + (user.level === 'gold' ? 'selected' : '') + '>é»„é‡‘ä¼šå‘˜</option>' +
                        '<option value="platinum" ' + (user.level === 'platinum' ? 'selected' : '') + '>é“‚é‡‘ä¼šå‘˜</option>' +
                        '</select>';
                    
                    row.innerHTML = '<td>' + user.phone + '</td>' +
                        '<td>' + (user.user_name || 'æœªè®¾ç½®') + '</td>' +
                        '<td>' + levelSelect + '</td>' +
                        '<td>' + user.total_quota + '</td>' +
                        '<td>' + user.used_quota + '</td>' +
                        '<td>' + (user.total_quota - user.used_quota) + '</td>' +
                        '<td>' + formatDate(user.created_at) + '</td>' +
                        '<td>' +
                        '<button class="btn-table btn-edit" onclick="editUserQuota(' + user.id + ', ' + user.total_quota + ')">' +
                        'ä¿®æ”¹é¢åº¦' +
                        '</button>' +
                        '<button class="btn-table ' + (user.disabled ? 'btn-edit' : 'btn-disable') + '" ' +
                        'onclick="toggleUserStatus(' + user.id + ', ' + user.disabled + ')">' +
                        (user.disabled ? 'å¯ç”¨' : 'åœç”¨') +
                        '</button>' +
                        '<button class="btn-table btn-edit" onclick="editUserName(' + user.id + ', \'' + (user.user_name || '') + '\')">' +
                        'æ”¹å' +
                        '</button>' +
                        '</td>';
                    tbody.appendChild(row);
                }
                
                showToast('åŠ è½½æˆåŠŸï¼Œå…± ' + users.length + ' ä¸ªç”¨æˆ·', 'success');
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·ç­‰çº§
        // ========================================
        async function changeUserLevel(userId, selectElement) {
            if (!checkSystemInit()) return;
            
            const newLevel = selectElement.value;
            const oldLevel = selectElement.getAttribute('data-old-level');
            
            if (newLevel === oldLevel) {
                return;
            }
            
            const levelNames = {
                'trial': 'è¯•ç”¨è´¦æˆ·',
                'gold': 'é»„é‡‘ä¼šå‘˜',
                'platinum': 'é“‚é‡‘ä¼šå‘˜'
            };
            
            if (!confirm('ç¡®å®šè¦å°†ç”¨æˆ·ç­‰çº§ä¿®æ”¹ä¸º ' + levelNames[newLevel] + ' å—ï¼Ÿ')) {
                selectElement.value = oldLevel;
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ä¿®æ”¹ç”¨æˆ·ç­‰çº§...');
                
                const result = await supabaseClient
                    .from('users')
                    .update({ level: newLevel })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                selectElement.setAttribute('data-old-level', newLevel);
                
                hideLoading();
                showToast('ç”¨æˆ·ç­‰çº§ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
                
            } catch (error) {
                console.error('ä¿®æ”¹ç”¨æˆ·ç­‰çº§å¤±è´¥:', error);
                hideLoading();
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
                selectElement.value = oldLevel;
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·é¢åº¦
        // ========================================
        async function editUserQuota(userId, currentQuota) {
            if (!checkSystemInit()) return;
            
            const newQuota = prompt('è¯·è¾“å…¥æ–°çš„æ€»é¢åº¦ï¼š', currentQuota);
            
            if (newQuota === null) return;
            
            const quotaNum = parseInt(newQuota);
            if (isNaN(quotaNum) || quotaNum < 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢åº¦æ•°å­—', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ä¿®æ”¹é¢åº¦...');
                
                const result = await supabaseClient
                    .from('users')
                    .update({ total_quota: quotaNum })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                hideLoading();
                showToast('é¢åº¦ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
                
            } catch (error) {
                console.error('ä¿®æ”¹é¢åº¦å¤±è´¥:', error);
                hideLoading();
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·åå­—
        // ========================================
        async function editUserName(userId, currentName) {
            if (!checkSystemInit()) return;
            
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·åï¼š', currentName);
            
            if (newName === null) return;
            
            const trimmedName = newName.trim();
            if (!trimmedName) {
                showToast('ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            if (trimmedName.length < 2 || trimmedName.length > 20) {
                showToast('ç”¨æˆ·åé•¿åº¦åº”åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ä¿®æ”¹ç”¨æˆ·å...');
                
                const result = await supabaseClient
                    .from('users')
                    .update({ user_name: trimmedName })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                hideLoading();
                showToast('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
                
            } catch (error) {
                console.error('ä¿®æ”¹ç”¨æˆ·åå¤±è´¥:', error);
                hideLoading();
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåœç”¨/å¯ç”¨ç”¨æˆ·
        // ========================================
        async function toggleUserStatus(userId, currentStatus) {
            if (!checkSystemInit()) return;
            
            const action = currentStatus ? 'å¯ç”¨' : 'åœç”¨';
            
            if (!confirm('ç¡®å®šè¦' + action + 'è¯¥ç”¨æˆ·å—ï¼Ÿ')) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨' + action + 'ç”¨æˆ·...');
                
                const result = await supabaseClient
                    .from('users')
                    .update({ disabled: !currentStatus })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                hideLoading();
                showToast(action + 'æˆåŠŸï¼', 'success');
                loadAdminData();
                
            } catch (error) {
                console.error(action + 'å¤±è´¥:', error);
                hideLoading();
                showToast(action + 'å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å¯¼å‡ºï¼šå¯¼å‡ºæŸ¥è¯¢ç»“æœåˆ°Excel
        // ========================================
        function exportToExcel() {
            const tbody = document.getElementById('queryTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }
            
            const exportData = [];
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowId = row.id.replace('queryRow-', '');
                const expressNumber = document.getElementById('expressNumber-' + rowId).value.trim();
                const mobile = document.getElementById('mobile-' + rowId).value.trim();
                
                if (!expressNumber) continue;
                
                const statusText = row.cells[2].textContent.trim();
                const expressStatus = row.cells[3].textContent.trim();
                const company = row.cells[4].textContent.trim();
                
                const rowData = {
                    'å¿«é€’å•å·': expressNumber,
                    'æ‰‹æœºå·åå››ä½': mobile || '-',
                    'æŸ¥è¯¢çŠ¶æ€': statusText,
                    'å¿«é€’çŠ¶æ€': expressStatus,
                    'å¿«é€’å…¬å¸': company
                };
                
                // å¦‚æœæœ‰è¯¦ç»†æ•°æ®ï¼Œæ·»åŠ æ›´å¤šä¿¡æ¯
                const logisticsData = queryDataCache[rowId];
                if (logisticsData) {
                    rowData['æœ€æ–°æ¶ˆæ¯'] = logisticsData.latest_message || '-';
                    rowData['æœ€æ–°æ—¶é—´'] = logisticsData.latest_time || '-';
                    rowData['å¿«é€’å‘˜'] = logisticsData.courier || '-';
                    rowData['å¿«é€’å‘˜ç”µè¯'] = logisticsData.courier_phone || '-';
                }
                
                exportData.push(rowData);
            }
            
            if (exportData.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æŸ¥è¯¢ç»“æœ');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const filename = 'å¿«é€’æŸ¥è¯¢ç»“æœ_' + timestamp + '.xlsx';
                
                XLSX.writeFile(wb, filename);
                showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å¯¼å‡ºï¼šå¯¼å‡ºå†å²è®°å½•åˆ°Excel
        // ========================================
        function exportHistoryToExcel() {
            if (filteredHistoryData.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å†å²è®°å½•', 'error');
                return;
            }
            
            try {
                const exportData = filteredHistoryData.map(function(item) {
                    return {
                        'æŸ¥è¯¢æ—¶é—´': formatDate(item.query_time || item.created_at),
                        'å¿«é€’å•å·': item.express_number || '-',
                        'æ‰‹æœºå·': item.mobile || '-',
                        'å¿«é€’å…¬å¸': item.company_name || '-',
                        'å¿«é€’çŠ¶æ€': item.express_status || '-',
                        'æŸ¥è¯¢çŠ¶æ€': item.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æŸ¥è¯¢å†å²');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const filename = 'æŸ¥è¯¢å†å²_' + timestamp + '.xlsx';
                
                XLSX.writeFile(wb, filename);
                showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å¯¼å‡ºï¼šå¯¼å‡ºç”¨æˆ·åˆ—è¡¨åˆ°Excel
        // ========================================
        async function exportUsersToExcel() {
            if (!checkSystemInit()) return;
            
            try {
                showLoading('æ­£åœ¨å¯¼å‡ºç”¨æˆ·æ•°æ®...');
                
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const users = result.data;
                
                if (users.length === 0) {
                    hideLoading();
                    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„ç”¨æˆ·æ•°æ®', 'error');
                    return;
                }
                
                const exportData = users.map(function(user) {
                    return {
                        'æ‰‹æœºå·': user.phone,
                        'ç”¨æˆ·å': user.user_name || 'æœªè®¾ç½®',
                        'ä¼šå‘˜ç­‰çº§': getLevelText(user.level),
                        'æ€»é¢åº¦': user.total_quota,
                        'å·²ä½¿ç”¨': user.used_quota,
                        'å‰©ä½™é¢åº¦': user.total_quota - user.used_quota,
                        'è´¦æˆ·çŠ¶æ€': user.disabled ? 'å·²åœç”¨' : 'æ­£å¸¸',
                        'æ³¨å†Œæ—¶é—´': formatDate(user.created_at)
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ç”¨æˆ·åˆ—è¡¨');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const filename = 'ç”¨æˆ·åˆ—è¡¨_' + timestamp + '.xlsx';
                
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å¯¼å‡ºï¼šå¯¼å‡ºæ‰€æœ‰æŸ¥è¯¢æ—¥å¿—åˆ°Excel
        // ========================================
        async function exportAllLogsToExcel() {
            if (!checkSystemInit()) return;
            
            try {
                showLoading('æ­£åœ¨å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—...');
                
                const result = await supabaseClient
                    .from('query_logs')
                    .select('*, users(phone, user_name)')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const logs = result.data;
                
                if (logs.length === 0) {
                    hideLoading();
                    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—æ•°æ®', 'error');
                    return;
                }
                
                const exportData = logs.map(function(log) {
                    return {
                        'æŸ¥è¯¢æ—¶é—´': formatDate(log.query_time || log.created_at),
                        'ç”¨æˆ·æ‰‹æœº': log.users ? log.users.phone : '-',
                        'ç”¨æˆ·å': log.users ? (log.users.user_name || 'æœªè®¾ç½®') : '-',
                        'å¿«é€’å•å·': log.express_number || '-',
                        'æ‰‹æœºå·': log.mobile || '-',
                        'å¿«é€’å…¬å¸': log.company_name || '-',
                        'å¿«é€’çŠ¶æ€': log.express_status || '-',
                        'æŸ¥è¯¢çŠ¶æ€': log.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æŸ¥è¯¢æ—¥å¿—');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const filename = 'æŸ¥è¯¢æ—¥å¿—_' + timestamp + '.xlsx';
                
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        // ========================================
        // é”®ç›˜å¿«æ·é”®
        // ========================================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter: æ‰¹é‡æŸ¥è¯¢
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    batchQuery();
                }
            }
            
            // Ctrl/Cmd + N: æ·»åŠ æŸ¥è¯¢è¡Œ
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    addQueryRow();
                }
            }
            
            // Ctrl/Cmd + E: å¯¼å‡ºExcel
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    const historySection = document.getElementById('historySection');
                    if (historySection.classList.contains('active')) {
                        exportHistoryToExcel();
                    } else {
                        exportToExcel();
                    }
                }
            }
            
            // Ctrl/Cmd + H: æŸ¥çœ‹å†å²
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    showHistorySection();
                }
            }
            
            // Ctrl/Cmd + U: ä¿®æ”¹ç”¨æˆ·å
            if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    openEditNameModal();
                }
            }
            
            // Ctrl/Cmd + R: åˆ·æ–°æ•°æ®
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                if (document.getElementById('adminInterface').classList.contains('active')) {
                    loadAdminData();
                } else if (document.getElementById('userInterface').classList.contains('active')) {
                    const historySection = document.getElementById('historySection');
                    if (historySection.classList.contains('active')) {
                        loadHistoryData();
                    } else {
                        refreshUserInfo();
                    }
                }
            }
            
            // ESC: å…³é—­å¼¹çª—
            if (e.key === 'Escape') {
                const rechargeModal = document.getElementById('rechargeModal');
                const editNameModal = document.getElementById('editNameModal');
                
                if (rechargeModal && rechargeModal.classList.contains('active')) {
                    closeRechargeModal();
                }
                
                if (editNameModal && editNameModal.classList.contains('active')) {
                    closeEditNameModal();
                }
            }
        });

        // ========================================
        // å›è½¦é”®å¿«é€ŸæŸ¥è¯¢
        // ========================================
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id && e.target.id.startsWith('expressNumber-')) {
                const rowId = e.target.id.replace('expressNumber-', '');
                querySingleExpress(rowId);
            }
        });

        // ========================================
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        // ========================================
        document.getElementById('rechargeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRechargeModal();
            }
        });

        document.getElementById('editNameModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditNameModal();
            }
        });

        // ========================================
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        // ========================================
        window.addEventListener('load', async function() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸš€ å¿«é€’æŸ¥è¯¢ç³»ç»Ÿå¯åŠ¨');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            try {
                showLoading('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...');
                
                // åˆå§‹åŒ– Supabase
                await initSupabase();
                
                console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•çŠ¶æ€
                if (authToken && authToken !== 'admin') {
                    console.log('ğŸ” æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œå°è¯•è‡ªåŠ¨ç™»å½•...');
                    
                    try {
                        const result = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('id', parseInt(authToken))
                            .single();
                        
                        if (result.error) throw result.error;
                        
                        currentUser = result.data;
                        
                        if (currentUser.disabled) {
                            console.log('âš ï¸ è´¦æˆ·å·²è¢«åœç”¨');
                            localStorage.removeItem('authToken');
                            authToken = null;
                            currentUser = null;
                            hideLoading();
                            showToast('è´¦æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                            return;
                        }
                        
                        console.log('âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                        document.getElementById('unifiedLoginContainer').style.display = 'none';
                        document.getElementById('userInterface').classList.add('active');
                        updateUserPanel();
                        showQuerySection();
                        addQueryRow();
                        hideLoading();
                        showToast('æ¬¢è¿å›æ¥ï¼', 'success');
                        
                    } catch (error) {
                        console.error('âŒ è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
                        localStorage.removeItem('authToken');
                        authToken = null;
                        currentUser = null;
                        hideLoading();
                    }
                    
                } else if (authToken === 'admin') {
                    console.log('ğŸ” æ£€æµ‹åˆ°ç®¡ç†å‘˜ç™»å½•çŠ¶æ€');
                    document.getElementById('unifiedLoginContainer').style.display = 'none';
                    document.getElementById('adminInterface').classList.add('active');
                    loadAdminData();
                    hideLoading();
                    showToast('æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜ï¼', 'success');
                    
                } else {
                    console.log('â„¹ï¸ æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                    hideLoading();
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… ç³»ç»Ÿå¯åŠ¨å®Œæˆ');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('');
                console.log('ğŸ“‹ å¿«æ·é”®è¯´æ˜ï¼š');
                console.log('  Ctrl/Cmd + N      æ·»åŠ æŸ¥è¯¢è¡Œ');
                console.log('  Ctrl/Cmd + Enter  æ‰¹é‡æŸ¥è¯¢');
                console.log('  Ctrl/Cmd + E      å¯¼å‡ºExcel');
                console.log('  Ctrl/Cmd + H      æŸ¥çœ‹å†å²');
                console.log('  Ctrl/Cmd + U      ä¿®æ”¹ç”¨æˆ·å');
                console.log('  Ctrl/Cmd + R      åˆ·æ–°æ•°æ®');
                console.log('  ESC               å…³é—­å¼¹çª—');
                console.log('  Enter             å¿«é€ŸæŸ¥è¯¢ï¼ˆåœ¨å•å·è¾“å…¥æ¡†ä¸­ï¼‰');
                console.log('');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('é”™è¯¯è¯¦æƒ…:', error);
                
                hideLoading();
                
                let errorMsg = 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼š\n\n';
                
                if (error.message.includes('Supabase URL')) {
                    errorMsg += 'âŒ è¯·å…ˆé…ç½® Supabase URL\n';
                    errorMsg += 'åœ¨ä»£ç ä¸­æ‰¾åˆ° SUPABASE_CONFIG å¹¶å¡«å…¥æ­£ç¡®çš„ URL';
                } else if (error.message.includes('Supabase Key')) {
                    errorMsg += 'âŒ è¯·å…ˆé…ç½® Supabase Key\n';
                    errorMsg += 'åœ¨ä»£ç ä¸­æ‰¾åˆ° SUPABASE_CONFIG å¹¶å¡«å…¥æ­£ç¡®çš„ Key';
                } else if (error.message.includes('åº“æœªåŠ è½½')) {
                    errorMsg += 'âŒ Supabase åº“åŠ è½½å¤±è´¥\n';
                    errorMsg += 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®';
                } else if (error.message.includes('è¿æ¥')) {
                    errorMsg += 'âŒ æ•°æ®åº“è¿æ¥å¤±è´¥\n';
                    errorMsg += 'è¯·æ£€æŸ¥ Supabase é…ç½®æ˜¯å¦æ­£ç¡®\n';
                    errorMsg += 'æˆ–æ£€æŸ¥æ•°æ®åº“è¡¨æ˜¯å¦å·²åˆ›å»º';
                } else {
                    errorMsg += error.message;
                }
                
                errorMsg += '\n\nè¯·æ£€æŸ¥é…ç½®ååˆ·æ–°é¡µé¢é‡è¯•';
                
                alert(errorMsg);
                
                console.log('');
                console.log('ğŸ”§ é…ç½®æ£€æŸ¥æ¸…å•ï¼š');
                console.log('  1. æ˜¯å¦å·²åœ¨ Supabase åˆ›å»ºé¡¹ç›®ï¼Ÿ');
                console.log('  2. æ˜¯å¦å·²é…ç½® SUPABASE_CONFIG ä¸­çš„ URLï¼Ÿ');
                console.log('  3. æ˜¯å¦å·²é…ç½® SUPABASE_CONFIG ä¸­çš„ Keyï¼Ÿ');
                console.log('  4. æ˜¯å¦å·²åˆ›å»º users å’Œ query_logs è¡¨ï¼Ÿ');
                console.log('  5. æ˜¯å¦å·²é…ç½®è¡¨çš„ RLS ç­–ç•¥ï¼Ÿ');
                console.log('  6. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ');
                console.log('');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }
        });

        // ========================================
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        // ========================================
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser && authToken !== 'admin') {
                refreshUserInfo();
            }
        });

        // ========================================
        // å®šæœŸåˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯30ç§’ï¼‰
        // ========================================
        setInterval(function() {
            if (currentUser && authToken !== 'admin' && !document.hidden) {
                refreshUserInfo();
            }
        }, 30000);

        // ========================================
        // æ§åˆ¶å°æ¬¢è¿ä¿¡æ¯
        // ========================================
        console.log('%c å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ ', 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 20px; font-weight: bold; padding: 10px 20px; border-radius: 5px;');
        console.log('%c ç‰ˆæœ¬: 2.0.0 ', 'color: #667eea; font-size: 14px; font-weight: bold;');
        console.log('%c åŠŸèƒ½: å¿«é€’æŸ¥è¯¢ | å†å²è®°å½• | ç”¨æˆ·ç®¡ç† | æ•°æ®å¯¼å‡º ', 'color: #999; font-size: 12px;');
        console.log('');

    </script>
</body>
</html>
