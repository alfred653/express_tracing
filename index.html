<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ - Supabaseç‰ˆ</title>
    
    <!-- Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SheetJS Excelåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1400px;
            overflow: hidden;
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        #unifiedLoginContainer {
            padding: 60px 40px;
            text-align: center;
        }

        .login-title {
            font-size: 32px;
            color: #333;
            margin-bottom: 40px;
            font-weight: 600;
        }

        .login-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .tab-btn {
            padding: 12px 40px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .login-form {
            display: none;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        /* ç”¨æˆ·ç•Œé¢æ ·å¼ */
        #userInterface, #adminInterface {
            display: none;
            padding: 30px;
        }

        #userInterface.active, #adminInterface.active {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .logout-btn {
            padding: 10px 25px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff3838;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ·ä¿¡æ¯é¢æ¿ */
        .user-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .user-info-item {
            text-align: center;
        }

        .user-info-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .user-info-value {
            font-size: 24px;
            font-weight: 600;
        }

        /* æŸ¥è¯¢è¡¨æ ¼ */
        .query-section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .query-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .query-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .query-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .query-table input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .query-table input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-query {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .btn-query:hover {
            background: #5568d3;
        }

        .btn-add {
            padding: 10px 25px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-add:hover {
            background: #27ae60;
        }

        /* æ–°å¢ï¼šå¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .btn-export {
            padding: 10px 25px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-export:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        /* æ–°å¢ï¼šæ‰¹é‡æ“ä½œæŒ‰é’® */
        .btn-batch {
            padding: 10px 25px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-batch:hover {
            background: #8e44ad;
        }

        /* æ–°å¢ï¼šæ¸…ç©ºæŒ‰é’® */
        .btn-clear {
            padding: 10px 25px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-clear:hover {
            background: #7f8c8d;
        }

        .btn-delete {
            background: #e74c3c;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .btn-detail {
            background: #3498db;
        }

        .btn-detail:hover {
            background: #2980b9;
        }

        /* æŸ¥è¯¢çŠ¶æ€æ ‡ç­¾ */
        .query-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .query-status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .query-status-querying {
            background: #cce5ff;
            color: #004085;
        }

        .query-status-success {
            background: #d4edda;
            color: #155724;
        }

        .query-status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        /* å¿«é€’çŠ¶æ€æ ‡ç­¾ */
        .express-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }

        /* ç‰©æµçŠ¶æ€é¢œè‰² */
        .status-ACCEPT {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-TRANSPORT {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-DELIVERING {
            background: #fff9c4;
            color: #f57f17;
        }

        .status-SIGN {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-FAILED {
            background: #ffebee;
            color: #d32f2f;
        }

        .status-RETURNED {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-PROBLEM {
            background: #fce4ec;
            color: #c2185b;
        }

        .status-unknown {
            background: #f5f5f5;
            color: #616161;
        }

        /* ä¼šå‘˜ç­‰çº§æ ‡ç­¾ */
        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .level-trial {
            background: #e3f2fd;
            color: #1976d2;
        }

        .level-gold {
            background: #fff8e1;
            color: #f57f17;
        }

        .level-platinum {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* ç‰©æµè¯¦æƒ… */
        .logistics-details {
            margin-top: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            font-size: 13px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .logistics-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logistics-header-left {
            flex: 1;
            min-width: 200px;
        }

        .logistics-header-right {
            text-align: right;
        }

        .logistics-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .logistics-company {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .company-logo {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .company-name {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

        .logistics-meta {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .logistics-info-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-weight: 600;
        }

        .courier-info {
            color: #667eea;
        }

        .logistics-timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-left: 0;
        }

        .logistics-item {
            position: relative;
            padding: 15px 0;
            padding-left: 20px;
        }

        .logistics-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #667eea;
            z-index: 2;
        }

        .logistics-item:first-child::before {
            background: #2ecc71;
            box-shadow: 0 0 0 2px #2ecc71, 0 0 0 4px rgba(46, 204, 113, 0.2);
            width: 14px;
            height: 14px;
            left: -7px;
        }

        .logistics-item::after {
            content: '';
            position: absolute;
            left: -1px;
            top: 32px;
            width: 2px;
            height: calc(100% - 12px);
            background: linear-gradient(to bottom, #e0e0e0, transparent);
            z-index: 1;
        }

        .logistics-item:last-child::after {
            display: none;
        }

        .logistics-time {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            font-size: 13px;
        }

        .logistics-item:first-child .logistics-time {
            color: #2ecc71;
        }

        .logistics-content {
            color: #555;
            line-height: 1.6;
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #f0f0f0;
        }

        .logistics-item:first-child .logistics-content {
            border-left: 3px solid #2ecc71;
            font-weight: 500;
        }

        .logistics-area {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .logistics-empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ç®¡ç†å‘˜è¡¨æ ¼ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .admin-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .admin-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .btn-table {
            padding: 6px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-disable {
            background: #e74c3c;
            color: white;
        }

        .btn-disable:hover {
            background: #c0392b;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            #unifiedLoginContainer {
                padding: 40px 20px;
            }

            .login-title {
                font-size: 24px;
            }

            .user-panel {
                grid-template-columns: 1fr;
            }

            .query-table, .admin-table {
                font-size: 12px;
            }

            .query-table th, .query-table td,
            .admin-table th, .admin-table td {
                padding: 8px;
            }

            .logistics-timeline {
                padding-left: 20px;
            }

            .logistics-header {
                flex-direction: column;
            }

            .logistics-header-right {
                text-align: left;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #2ecc71;
        }

        .toast.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* æ–°å¢ï¼šåŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- ç»Ÿä¸€ç™»å½•ç•Œé¢ -->
    <div class="container">
        <div id="unifiedLoginContainer">
            <h1 class="login-title">ğŸ“¦ å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</h1>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchLoginTab('user')">ç”¨æˆ·ç™»å½•</button>
                <button class="tab-btn" onclick="switchLoginTab('admin')">ç®¡ç†å‘˜ç™»å½•</button>
            </div>

            <!-- ç”¨æˆ·ç™»å½•è¡¨å• -->
            <div id="userLoginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginUserPhone">æ‰‹æœºå·</label>
                    <input type="tel" id="loginUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                </div>
                <button class="login-btn" onclick="handleUserLogin()">ç™»å½• / æ³¨å†Œ</button>
                <p style="margin-top: 15px; color: #999; font-size: 14px;">
                    æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•è‡ªåŠ¨æ³¨å†Œï¼Œèµ é€1æ¬¡è¯•ç”¨é¢åº¦
                </p>
            </div>

            <!-- ç®¡ç†å‘˜ç™»å½•è¡¨å• -->
            <div id="adminLoginForm" class="login-form">
                <div class="form-group">
                    <label for="adminUsername">ç®¡ç†å‘˜è´¦å·</label>
                    <input type="text" id="adminUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
                </div>
                <div class="form-group">
                    <label for="adminPassword">å¯†ç </label>
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button class="login-btn" onclick="handleAdminLogin()">ç™»å½•</button>
                <p style="margin-top: 15px; color: #999; font-size: 14px;">
                    é»˜è®¤è´¦å·ï¼šadmin / å¯†ç ï¼šadmin123
                </p>
            </div>
        </div>

        <!-- ç”¨æˆ·ç•Œé¢ -->
        <div id="userInterface">
            <div class="header">
                <h1>ç”¨æˆ·ä¸­å¿ƒ</h1>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
            <div class="user-panel">
                <div class="user-info-item">
                    <div class="user-info-label">æ‰‹æœºå·</div>
                    <div class="user-info-value" id="userPhone">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ç”¨æˆ·å</div>
                    <div class="user-info-value" id="userName">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ä¼šå‘˜ç­‰çº§</div>
                    <div class="user-info-value" id="userLevel">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">æ€»é¢åº¦</div>
                    <div class="user-info-value" id="totalQuota">0</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">å·²ä½¿ç”¨</div>
                    <div class="user-info-value" id="usedQuota">0</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">å‰©ä½™é¢åº¦</div>
                    <div class="user-info-value" id="remainQuota">0</div>
                </div>
            </div>

            <!-- å¿«é€’æŸ¥è¯¢åŒºåŸŸ -->
            <div class="query-section">
                <h2 class="section-title">å¿«é€’æŸ¥è¯¢</h2>
                
                <!-- æ–°å¢ï¼šæ“ä½œæŒ‰é’®ç»„ -->
                <div class="action-buttons">
                    <button class="btn-add" onclick="addQueryRow()">
                        â• æ·»åŠ æŸ¥è¯¢
                    </button>
                    <button class="btn-export" onclick="exportToExcel()" id="exportBtn">
                        ğŸ“Š å¯¼å‡ºExcel
                    </button>
                    <button class="btn-batch" onclick="batchQuery()">
                        ğŸš€ æ‰¹é‡æŸ¥è¯¢
                    </button>
                    <button class="btn-clear" onclick="clearAllRows()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰
                    </button>
                </div>
                
                <table class="query-table">
                    <thead>
                        <tr>
                            <th style="width: 25%">å¿«é€’å•å·</th>
                            <th style="width: 15%">æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰</th>
                            <th style="width: 12%">æŸ¥è¯¢çŠ¶æ€</th>
                            <th style="width: 15%">å¿«é€’çŠ¶æ€</th>
                            <th style="width: 15%">å¿«é€’å…¬å¸</th>
                            <th style="width: 18%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="queryTableBody">
                        <!-- åŠ¨æ€æ·»åŠ è¡Œ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ç•Œé¢ -->
        <div id="adminInterface">
            <div class="header">
                <h1>ç®¡ç†å‘˜åå°</h1>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <div class="query-section">
                <h2 class="section-title">ç”¨æˆ·ç®¡ç†</h2>
                
                <!-- æ–°å¢ï¼šç®¡ç†å‘˜å¯¼å‡ºæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn-export" onclick="exportUsersToExcel()">
                        ğŸ“Š å¯¼å‡ºç”¨æˆ·æ•°æ®
                    </button>
                    <button class="btn-export" onclick="exportAllLogsToExcel()">
                        ğŸ“‹ å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—
                    </button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>æ‰‹æœºå·</th>
                            <th>ç”¨æˆ·å</th>
                            <th>ä¼šå‘˜ç­‰çº§</th>
                            <th>æ€»é¢åº¦</th>
                            <th>å·²ä½¿ç”¨</th>
                            <th>å‰©ä½™é¢åº¦</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTableBody">
                        <!-- åŠ¨æ€æ·»åŠ ç”¨æˆ·æ•°æ® -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šåŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†ä¸­...</div>
        </div>
    </div>

    <script>
        // ========================================
        // Supabase é…ç½®ï¼ˆé‡è¦ï¼šæ›¿æ¢ä¸ºä½ çš„å®é™…é…ç½®ï¼‰
        // ========================================
        const SUPABASE_CONFIG = {
            url: 'https://pukyydqtctlvexbndvep.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1a3l5ZHF0Y3RsdmV4Ym5kdmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzQ0MjIsImV4cCI6MjA4MjQxMDQyMn0.1u5yf_3RJWgoJxxMg-CsYZViraJjreMXRH3XBslJaco'
        };

        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

        // ========================================
        // å…¨å±€å˜é‡
        // ========================================
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let queryRowCounter = 0;
        let queryDataCache = {};

        // ç‰©æµçŠ¶æ€ä¸­æ–‡æ˜ å°„
        const LOGISTICS_STATUS_MAP = {
            'ACCEPT': 'å·²æ½æ”¶',
            'TRANSPORT': 'è¿è¾“ä¸­',
            'DELIVERING': 'æ´¾é€ä¸­',
            'SIGN': 'å·²ç­¾æ”¶',
            'FAILED': 'æŠ•é€’å¤±è´¥',
            'RETURNED': 'å·²é€€å›',
            'PROBLEM': 'é—®é¢˜ä»¶'
        };

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        // ========================================
        function showLoading(text) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (text) loadingText.textContent = text;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯
        // ========================================
        function showToast(message, type) {
            type = type || 'success';
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(function() {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(function() {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ========================================
        // ç™»å½•ç•Œé¢ï¼šåˆ‡æ¢æ ‡ç­¾é¡µ
        // ========================================
        function switchLoginTab(type) {
            const userTab = document.querySelector('.tab-btn:first-child');
            const adminTab = document.querySelector('.tab-btn:last-child');
            const userForm = document.getElementById('userLoginForm');
            const adminForm = document.getElementById('adminLoginForm');

            if (type === 'user') {
                userTab.classList.add('active');
                adminTab.classList.remove('active');
                userForm.classList.add('active');
                adminForm.classList.remove('active');
            } else {
                adminTab.classList.add('active');
                userTab.classList.remove('active');
                adminForm.classList.add('active');
                userForm.classList.remove('active');
            }
        }

        // ========================================
        // ç”¨æˆ·ç™»å½•/æ³¨å†Œ
        // ========================================
        async function handleUserLogin() {
            const phone = document.getElementById('loginUserPhone').value.trim();
            
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error');
                return;
            }
            
            try {
                const queryResult = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                const existUser = queryResult.data;
                const queryError = queryResult.error;
                
                if (queryError && queryError.code !== 'PGRST116') {
                    throw queryError;
                }
                
                if (!existUser) {
                    const insertResult = await supabaseClient
                        .from('users')
                        .insert([{
                            phone: phone,
                            user_name: 'æ–°ç”¨æˆ·',
                            avatar: 'color-1',
                            level: 'trial',
                            total_quota: 1,
                            used_quota: 0,
                            disabled: false
                        }])
                        .select()
                        .single();
                    
                    if (insertResult.error) throw insertResult.error;
                    
                    currentUser = insertResult.data;
                    showToast('æ³¨å†ŒæˆåŠŸï¼èµ é€1æ¬¡è¯•ç”¨é¢åº¦', 'success');
                } else {
                    if (existUser.disabled) {
                        showToast('è´¦æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                        return;
                    }
                    currentUser = existUser;
                    showToast('ç™»å½•æˆåŠŸï¼', 'success');
                }
                
                authToken = currentUser.id.toString();
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('userInterface').classList.add('active');
                
                updateUserPanel();
                addQueryRow();
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showToast('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ç™»å½•
        // ========================================
        async function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!username || !password) {
                showToast('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }
            
            if (username === 'admin' && password === 'admin123') {
                authToken = 'admin';
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('adminInterface').classList.add('active');
                
                loadAdminData();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
            } else {
                showToast('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
            }
        }

        // ========================================
        // é€€å‡ºç™»å½•
        // ========================================
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            queryDataCache = {};
            
            document.getElementById('userInterface').classList.remove('active');
            document.getElementById('adminInterface').classList.remove('active');
            document.getElementById('unifiedLoginContainer').style.display = 'block';
            
            document.getElementById('loginUserPhone').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('queryTableBody').innerHTML = '';
            queryRowCounter = 0;
            
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        // ========================================
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯é¢æ¿
        // ========================================
        function updateUserPanel() {
            if (!currentUser) return;
            
            document.getElementById('userPhone').textContent = currentUser.phone;
            document.getElementById('userName').textContent = currentUser.user_name || 'æ–°ç”¨æˆ·';
            document.getElementById('userLevel').textContent = getLevelText(currentUser.level);
            document.getElementById('totalQuota').textContent = currentUser.total_quota;
            document.getElementById('usedQuota').textContent = currentUser.used_quota;
            document.getElementById('remainQuota').textContent = currentUser.total_quota - currentUser.used_quota;
        }

        // ========================================
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        // ========================================
        async function refreshUserInfo() {
            if (!authToken || authToken === 'admin') return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', parseInt(authToken))
                    .single();
                
                if (result.error) throw result.error;
                
                currentUser = result.data;
                updateUserPanel();
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            }
        }

        // ========================================
        // è·å–ä¼šå‘˜ç­‰çº§æ–‡æœ¬
        // ========================================
        function getLevelText(level) {
            const levels = {
                'trial': 'è¯•ç”¨ä¼šå‘˜',
                'gold': 'é»„é‡‘ä¼šå‘˜',
                'platinum': 'é“‚é‡‘ä¼šå‘˜'
            };
            return levels[level] || level;
        }

        // ========================================
        // æ·»åŠ æŸ¥è¯¢è¡Œ
        // ========================================
        function addQueryRow() {
            queryRowCounter++;
            const id = queryRowCounter;
            
            const tbody = document.getElementById('queryTableBody');
            const row = document.createElement('tr');
            row.id = 'row-' + id;
            row.innerHTML = '<td>' +
                '<input type="text" id="number-' + id + '" placeholder="è¯·è¾“å…¥å¿«é€’å•å·">' +
                '</td>' +
                '<td>' +
                '<input type="tel" id="mobile-' + id + '" placeholder="é€‰å¡«ï¼Œéƒ¨åˆ†å¿«é€’éœ€è¦" maxlength="11">' +
                '</td>' +
                '<td>' +
                '<span class="query-status-badge query-status-pending" id="query-status-' + id + '">å¾…æŸ¥è¯¢</span>' +
                '</td>' +
                '<td id="express-status-' + id + '">-</td>' +
                '<td id="company-' + id + '">-</td>' +
                '<td>' +
                '<button class="btn-query" onclick="querySingle(' + id + ')">æŸ¥è¯¢</button>' +
                '<button class="btn-query btn-detail" onclick="toggleDetail(' + id + ')" id="detail-btn-' + id + '" style="display:none;">è¯¦æƒ…</button>' +
                '<button class="btn-query btn-delete" onclick="deleteRow(' + id + ')">åˆ é™¤</button>' +
                '</td>';
            tbody.appendChild(row);
            
            const detailRow = document.createElement('tr');
            detailRow.id = 'detail-' + id;
            detailRow.style.display = 'none';
            detailRow.innerHTML = '<td colspan="6">' +
                '<div class="logistics-details" id="logistics-' + id + '"></div>' +
                '</td>';
            tbody.appendChild(detailRow);
        }

        // ========================================
        // åˆ é™¤æŸ¥è¯¢è¡Œ
        // ========================================
        function deleteRow(id) {
            const row = document.getElementById('row-' + id);
            const detailRow = document.getElementById('detail-' + id);
            
            if (row) row.remove();
            if (detailRow) detailRow.remove();
            
            delete queryDataCache[id];
        }

        // ========================================
        // æ–°å¢ï¼šæ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è¡Œ
        // ========================================
        function clearAllRows() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            document.getElementById('queryTableBody').innerHTML = '';
            queryDataCache = {};
            queryRowCounter = 0;
            showToast('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•', 'success');
        }

        // ========================================
        // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤º
        // ========================================
        function toggleDetail(id) {
            const detailRow = document.getElementById('detail-' + id);
            const btn = document.getElementById('detail-btn-' + id);
            
            if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                btn.textContent = 'æ”¶èµ·';
            } else {
                detailRow.style.display = 'none';
                btn.textContent = 'è¯¦æƒ…';
            }
        }
        // ========================================
        // æ–°å¢ï¼šæ‰¹é‡æŸ¥è¯¢åŠŸèƒ½
        // ========================================
        async function batchQuery() {
            const tbody = document.getElementById('queryTableBody');
            const rows = tbody.querySelectorAll('tr[id^="row-"]');
            
            if (rows.length === 0) {
                showToast('è¯·å…ˆæ·»åŠ æŸ¥è¯¢å•å·', 'error');
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰å¾…æŸ¥è¯¢çš„å•å·
            const queryList = [];
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const id = row.id.replace('row-', '');
                const numberInput = document.getElementById('number-' + id);
                const statusElement = document.getElementById('query-status-' + id);
                
                if (numberInput && numberInput.value.trim() && 
                    statusElement && statusElement.textContent === 'å¾…æŸ¥è¯¢') {
                    queryList.push(parseInt(id));
                }
            }
            
            if (queryList.length === 0) {
                showToast('æ²¡æœ‰éœ€è¦æŸ¥è¯¢çš„å•å·', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ‰¹é‡æŸ¥è¯¢ ' + queryList.length + ' ä¸ªå•å·å—ï¼Ÿ')) {
                return;
            }
            
            showLoading('æ­£åœ¨æ‰¹é‡æŸ¥è¯¢ä¸­... (0/' + queryList.length + ')');
            
            let successCount = 0;
            let failCount = 0;
            
            // é€ä¸ªæŸ¥è¯¢ï¼ˆé¿å…å¹¶å‘è¿‡å¤šï¼‰
            for (let i = 0; i < queryList.length; i++) {
                const id = queryList[i];
                
                try {
                    document.getElementById('loadingText').textContent = 
                        'æ­£åœ¨æ‰¹é‡æŸ¥è¯¢ä¸­... (' + (i + 1) + '/' + queryList.length + ')';
                    
                    await querySingle(id);
                    successCount++;
                    
                    // å»¶è¿Ÿ500msï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', error);
                    failCount++;
                }
            }
            
            hideLoading();
            showToast('æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼æˆåŠŸï¼š' + successCount + 'ï¼Œå¤±è´¥ï¼š' + failCount, 'success');
        }

        // ========================================
        // æ–°å¢ï¼šå¯¼å‡ºExcelåŠŸèƒ½ï¼ˆç”¨æˆ·æŸ¥è¯¢è®°å½•ï¼‰
        // ========================================
        function exportToExcel() {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æŸ¥è¯¢æ•°æ®
                if (Object.keys(queryDataCache).length === 0) {
                    showToast('æš‚æ— å¯å¯¼å‡ºçš„æŸ¥è¯¢è®°å½•', 'error');
                    return;
                }
                
                showLoading('æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶...');
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // ========== å·¥ä½œè¡¨1ï¼šæŸ¥è¯¢æ¦‚è§ˆ ==========
                const summaryData = [];
                summaryData.push(['å¿«é€’æŸ¥è¯¢è®°å½•æ±‡æ€»']);
                summaryData.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                summaryData.push(['ç”¨æˆ·', currentUser ? currentUser.user_name : 'æœªçŸ¥']);
                summaryData.push(['æ‰‹æœºå·', currentUser ? currentUser.phone : 'æœªçŸ¥']);
                summaryData.push(['æŸ¥è¯¢æ•°é‡', Object.keys(queryDataCache).length + ' æ¡']);
                summaryData.push([]);
                summaryData.push(['å¿«é€’å•å·', 'å¿«é€’å…¬å¸', 'ç‰©æµçŠ¶æ€', 'æœ€æ–°æ¶ˆæ¯', 'å¿«é€’å‘˜', 'è”ç³»ç”µè¯', 'è€—æ—¶']);
                
                // æ·»åŠ æ¯æ¡æŸ¥è¯¢è®°å½•
                for (const id in queryDataCache) {
                    const data = queryDataCache[id];
                    summaryData.push([
                        data.number || '',
                        data.expressCompanyName || '',
                        data.logisticsStatusDesc || '',
                        data.theLastMessage || '',
                        data.courier || '',
                        data.courierPhone || '',
                        data.takeTime || ''
                    ]);
                }
                
                const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
                
                // è®¾ç½®åˆ—å®½
                ws1['!cols'] = [
                    { wch: 20 },  // å¿«é€’å•å·
                    { wch: 15 },  // å¿«é€’å…¬å¸
                    { wch: 12 },  // ç‰©æµçŠ¶æ€
                    { wch: 50 },  // æœ€æ–°æ¶ˆæ¯
                    { wch: 10 },  // å¿«é€’å‘˜
                    { wch: 15 },  // è”ç³»ç”µè¯
                    { wch: 15 }   // è€—æ—¶
                ];
                
                XLSX.utils.book_append_sheet(wb, ws1, 'æŸ¥è¯¢æ¦‚è§ˆ');
                
                // ========== å·¥ä½œè¡¨2-Nï¼šæ¯ä¸ªå¿«é€’çš„è¯¦ç»†ç‰©æµè½¨è¿¹ ==========
                let sheetIndex = 1;
                for (const id in queryDataCache) {
                    const data = queryDataCache[id];
                    
                    if (!data.logisticsTraceDetails || data.logisticsTraceDetails.length === 0) {
                        continue;
                    }
                    
                    const detailData = [];
                    detailData.push(['å¿«é€’å•å·', data.number || '']);
                    detailData.push(['å¿«é€’å…¬å¸', data.expressCompanyName || '']);
                    detailData.push(['ç‰©æµçŠ¶æ€', data.logisticsStatusDesc || '']);
                    detailData.push(['å¿«é€’å‘˜', data.courier || '']);
                    detailData.push(['è”ç³»ç”µè¯', data.courierPhone || '']);
                    detailData.push(['è€—æ—¶', data.takeTime || '']);
                    detailData.push([]);
                    detailData.push(['æ—¶é—´', 'ç‰©æµçŠ¶æ€', 'è¯¦ç»†æè¿°', 'æ‰€åœ¨åœ°åŒº']);
                    
                    // æ·»åŠ ç‰©æµè½¨è¿¹
                    for (let i = 0; i < data.logisticsTraceDetails.length; i++) {
                        const item = data.logisticsTraceDetails[i];
                        const time = item.time ? new Date(item.time).toLocaleString('zh-CN') : '';
                        const status = LOGISTICS_STATUS_MAP[item.logisticsStatus] || item.logisticsStatus || '';
                        
                        detailData.push([
                            time,
                            status,
                            item.desc || '',
                            item.areaName || ''
                        ]);
                    }
                    
                    const ws = XLSX.utils.aoa_to_sheet(detailData);
                    
                    // è®¾ç½®åˆ—å®½
                    ws['!cols'] = [
                        { wch: 20 },  // æ—¶é—´
                        { wch: 12 },  // ç‰©æµçŠ¶æ€
                        { wch: 60 },  // è¯¦ç»†æè¿°
                        { wch: 20 }   // æ‰€åœ¨åœ°åŒº
                    ];
                    
                    // å·¥ä½œè¡¨åç§°ï¼ˆæœ€å¤š31ä¸ªå­—ç¬¦ï¼Œä¸”ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼‰
                    let sheetName = 'ç‰©æµè¯¦æƒ…' + sheetIndex;
                    if (data.number && data.number.length <= 15) {
                        sheetName = data.number.substring(0, 15);
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    sheetIndex++;
                    
                    // é™åˆ¶æœ€å¤š20ä¸ªå·¥ä½œè¡¨
                    if (sheetIndex > 20) {
                        break;
                    }
                }
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = 'å¿«é€’æŸ¥è¯¢è®°å½•_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx';
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // æ–°å¢ï¼šç®¡ç†å‘˜å¯¼å‡ºç”¨æˆ·æ•°æ®
        // ========================================
        async function exportUsersToExcel() {
            try {
                showLoading('æ­£åœ¨å¯¼å‡ºç”¨æˆ·æ•°æ®...');
                
                // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const users = result.data;
                
                if (users.length === 0) {
                    hideLoading();
                    showToast('æš‚æ— ç”¨æˆ·æ•°æ®', 'error');
                    return;
                }
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // å‡†å¤‡æ•°æ®
                const data = [];
                data.push(['ç”¨æˆ·æ•°æ®å¯¼å‡º']);
                data.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                data.push(['ç”¨æˆ·æ€»æ•°', users.length + ' äºº']);
                data.push([]);
                data.push(['æ‰‹æœºå·', 'ç”¨æˆ·å', 'ä¼šå‘˜ç­‰çº§', 'æ€»é¢åº¦', 'å·²ä½¿ç”¨', 'å‰©ä½™é¢åº¦', 'è´¦æˆ·çŠ¶æ€', 'æ³¨å†Œæ—¶é—´']);
                
                // æ·»åŠ ç”¨æˆ·æ•°æ®
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    data.push([
                        user.phone || '',
                        user.user_name || '',
                        getLevelText(user.level),
                        user.total_quota || 0,
                        user.used_quota || 0,
                        (user.total_quota - user.used_quota) || 0,
                        user.disabled ? 'å·²åœç”¨' : 'æ­£å¸¸',
                        formatDate(user.created_at)
                    ]);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 15 },  // æ‰‹æœºå·
                    { wch: 15 },  // ç”¨æˆ·å
                    { wch: 12 },  // ä¼šå‘˜ç­‰çº§
                    { wch: 10 },  // æ€»é¢åº¦
                    { wch: 10 },  // å·²ä½¿ç”¨
                    { wch: 10 },  // å‰©ä½™é¢åº¦
                    { wch: 10 },  // è´¦æˆ·çŠ¶æ€
                    { wch: 20 }   // æ³¨å†Œæ—¶é—´
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'ç”¨æˆ·æ•°æ®');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = 'ç”¨æˆ·æ•°æ®_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx';
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼å…± ' + users.length + ' æ¡ç”¨æˆ·æ•°æ®', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // æ–°å¢ï¼šç®¡ç†å‘˜å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—
        // ========================================
        async function exportAllLogsToExcel() {
            try {
                showLoading('æ­£åœ¨å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—...');
                
                // è·å–æ‰€æœ‰æŸ¥è¯¢æ—¥å¿—
                const result = await supabaseClient
                    .from('query_logs')
                    .select('*, users(phone, user_name)')
                    .order('created_at', { ascending: false })
                    .limit(1000);  // é™åˆ¶æœ€å¤š1000æ¡
                
                if (result.error) throw result.error;
                
                const logs = result.data;
                
                if (logs.length === 0) {
                    hideLoading();
                    showToast('æš‚æ— æŸ¥è¯¢æ—¥å¿—', 'error');
                    return;
                }
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // å‡†å¤‡æ•°æ®
                const data = [];
                data.push(['æŸ¥è¯¢æ—¥å¿—å¯¼å‡º']);
                data.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                data.push(['æ—¥å¿—æ€»æ•°', logs.length + ' æ¡']);
                data.push([]);
                data.push(['æŸ¥è¯¢æ—¶é—´', 'ç”¨æˆ·æ‰‹æœºå·', 'ç”¨æˆ·å', 'å¿«é€’å•å·', 'æ‰‹æœºå·', 'å¿«é€’å…¬å¸', 'æŸ¥è¯¢çŠ¶æ€']);
                
                // æ·»åŠ æ—¥å¿—æ•°æ®
                for (let i = 0; i < logs.length; i++) {
                    const log = logs[i];
                    data.push([
                        formatDate(log.created_at),
                        log.users ? log.users.phone : '',
                        log.users ? log.users.user_name : '',
                        log.express_number || '',
                        log.mobile || '',
                        log.company_name || '',
                        log.status || ''
                    ]);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 20 },  // æŸ¥è¯¢æ—¶é—´
                    { wch: 15 },  // ç”¨æˆ·æ‰‹æœºå·
                    { wch: 15 },  // ç”¨æˆ·å
                    { wch: 20 },  // å¿«é€’å•å·
                    { wch: 15 },  // æ‰‹æœºå·
                    { wch: 15 },  // å¿«é€’å…¬å¸
                    { wch: 10 }   // æŸ¥è¯¢çŠ¶æ€
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'æŸ¥è¯¢æ—¥å¿—');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = 'æŸ¥è¯¢æ—¥å¿—_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx';
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼å…± ' + logs.length + ' æ¡æŸ¥è¯¢æ—¥å¿—', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å•ä¸ªæŸ¥è¯¢ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
        // ========================================
        async function querySingle(id) {
            const number = document.getElementById('number-' + id).value.trim();
            const mobile = document.getElementById('mobile-' + id).value.trim();
            
            if (!number) {
                showToast('è¯·è¾“å…¥å¿«é€’å•å·', 'error');
                return;
            }
            
            if (!authToken || authToken === 'admin') {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            updateQueryStatus(id, 'querying');
            
            try {
                const userResult = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', parseInt(authToken))
                    .single();
                
                if (userResult.error) throw userResult.error;
                
                const user = userResult.data;
                
                if (user.used_quota >= user.total_quota) {
                    updateQueryStatus(id, 'failed');
                    showToast('æŸ¥è¯¢é¢åº¦ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å……å€¼', 'error');
                    return;
                }
                
                const configResult = await supabaseClient
                    .from('system_config')
                    .select('config_value')
                    .eq('config_key', 'API_APPCODE')
                    .single();
                
                if (configResult.error) {
                    throw new Error('APIæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
                }
                
                const apiCode = configResult.data.config_value;
                
                const formData = new URLSearchParams();
                formData.append('number', number);
                if (mobile) {
                    formData.append('mobile', mobile);
                }
                
                console.log('å‘é€æŸ¥è¯¢è¯·æ±‚:', { number, mobile });
                
                const response = await fetch('https://jmexpresv2.market.alicloudapi.com/express/query-v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'APPCODE ' + apiCode,
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: formData
                });
                
                const result = await response.json();
                console.log('APIè¿”å›ç»“æœ:', result);
                
                if (result.code === 200 && result.data) {
                    queryDataCache[id] = result.data;
                    
                    updateRowData(id, result.data);
                    updateQueryStatus(id, 'success');
                    
                    const detailBtn = document.getElementById('detail-btn-' + id);
                    if (detailBtn) detailBtn.style.display = 'inline-block';
                    
                    await supabaseClient
                        .from('users')
                        .update({ used_quota: user.used_quota + 1 })
                        .eq('id', parseInt(authToken));
                    
                    await supabaseClient
                        .from('query_logs')
                        .insert([{
                            user_id: parseInt(authToken),
                            express_number: number,
                            mobile: mobile || '',
                            company_name: result.data.expressCompanyName || 'æœªçŸ¥',
                            status: 'success'
                        }]);
                    
                    await refreshUserInfo();
                    showToast('æŸ¥è¯¢æˆåŠŸï¼', 'success');
                } else {
                    updateQueryStatus(id, 'failed');
                    showToast(result.msg || 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥å•å·æ˜¯å¦æ­£ç¡®', 'error');
                }
                
            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
                updateQueryStatus(id, 'failed');
                showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // æ›´æ–°æŸ¥è¯¢çŠ¶æ€
        // ========================================
        function updateQueryStatus(id, status) {
            const statusElement = document.getElementById('query-status-' + id);
            if (!statusElement) return;
            
            const statusMap = {
                'pending': { text: 'å¾…æŸ¥è¯¢', className: 'query-status-pending' },
                'querying': { text: 'æŸ¥è¯¢ä¸­...', className: 'query-status-querying' },
                'success': { text: 'æŸ¥è¯¢æˆåŠŸ', className: 'query-status-success' },
                'failed': { text: 'æŸ¥è¯¢å¤±è´¥', className: 'query-status-failed' }
            };
            
            const statusInfo = statusMap[status];
            if (statusInfo) {
                statusElement.textContent = statusInfo.text;
                statusElement.className = 'query-status-badge ' + statusInfo.className;
            }
        }

        // ========================================
        // æ›´æ–°è¡Œæ•°æ®ï¼ˆæ˜¾ç¤ºå¿«é€’ä¿¡æ¯ï¼‰
        // ========================================
        function updateRowData(id, data) {
            const companyElement = document.getElementById('company-' + id);
            if (companyElement) {
                companyElement.textContent = data.expressCompanyName || 'æœªçŸ¥';
            }
            
            const expressStatusElement = document.getElementById('express-status-' + id);
            if (expressStatusElement) {
                const statusDesc = data.logisticsStatusDesc || LOGISTICS_STATUS_MAP[data.logisticsStatus] || 'æœªçŸ¥';
                const statusClass = 'status-' + (data.logisticsStatus || 'unknown');
                expressStatusElement.innerHTML = '<span class="express-status ' + statusClass + '">' + statusDesc + '</span>';
            }
            
            const logisticsElement = document.getElementById('logistics-' + id);
            
            if (logisticsElement) {
                let html = '<div class="logistics-header">';
                html += '<div class="logistics-header-left">';
                html += '<div class="logistics-title">ğŸ“¦ ' + (data.number || 'å¿«é€’å•å·') + '</div>';
                html += '<div class="logistics-company">';
                if (data.expressCompanyLogo) {
                    html += '<img src="' + data.expressCompanyLogo + '" class="company-logo" alt="logo">';
                }
                html += '<span class="company-name">' + (data.expressCompanyName || 'æœªçŸ¥å¿«é€’') + '</span>';
                html += '</div>';
                if (data.takeTime) {
                    html += '<div class="logistics-meta">â±ï¸ è€—æ—¶ï¼š' + data.takeTime + '</div>';
                }
                html += '</div>';
                
                html += '<div class="logistics-header-right">';
                const statusDesc = data.logisticsStatusDesc || 'æœªçŸ¥çŠ¶æ€';
                const statusClass = 'status-' + (data.logisticsStatus || 'unknown');
                html += '<span class="express-status ' + statusClass + '">' + statusDesc + '</span>';
                html += '</div>';
                html += '</div>';
                
                if (data.courier || data.courierPhone) {
                    html += '<div class="logistics-info-box">';
                    if (data.courier) {
                        html += '<div class="info-row">';
                        html += '<span class="info-label">ğŸ‘¤ å¿«é€’å‘˜ï¼š</span>';
                        html += '<span class="info-value courier-info">' + data.courier + '</span>';
                        html += '</div>';
                    }
                    if (data.courierPhone) {
                        html += '<div class="info-row">';
                        html += '<span class="info-label">ğŸ“ è”ç³»æ–¹å¼ï¼š</span>';
                        html += '<span class="info-value courier-info">' + data.courierPhone + '</span>';
                        html += '</div>';
                    }
                    html += '</div>';
                }
                
                if (data.theLastMessage) {
                    html += '<div class="logistics-info-box">';
                    html += '<div class="info-row" style="flex-direction: column; align-items: flex-start;">';
                    html += '<span class="info-label">ğŸ“ æœ€æ–°æ¶ˆæ¯ï¼š</span>';
                    html += '<span class="info-value" style="margin-top: 5px;">' + data.theLastMessage + '</span>';
                    html += '</div>';
                    html += '</div>';
                }
                
                if (data.logisticsTraceDetails && data.logisticsTraceDetails.length > 0) {
                    html += '<div class="timeline-title">ğŸšš ç‰©æµè½¨è¿¹</div>';
                    html += '<div class="logistics-timeline">';
                    
                    for (let i = 0; i < data.logisticsTraceDetails.length; i++) {
                        const item = data.logisticsTraceDetails[i];
                        const time = item.time ? new Date(item.time).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '';
                        
                        html += '<div class="logistics-item">';
                        html += '<span class="logistics-time">' + time + '</span>';
                        html += '<div class="logistics-content">' + (item.desc || '') + '</div>';
                        if (item.areaName) {
                            html += '<div class="logistics-area">ğŸ“ ' + item.areaName + '</div>';
                        }
                        html += '</div>';
                    }
                    
                    html += '</div>';
                } else {
                    html += '<div class="logistics-empty">æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯</div>';
                }
                
                logisticsElement.innerHTML = html;
            }
        }
        // ========================================
        // ç®¡ç†å‘˜ï¼šåŠ è½½æ‰€æœ‰ç”¨æˆ·
        // ========================================
        async function loadAdminData() {
            try {
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const users = result.data;
                const tbody = document.getElementById('adminUsersTableBody');
                tbody.innerHTML = '';
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr>' +
                        '<td colspan="8" style="text-align: center; padding: 40px; color: #999;">' +
                        'æš‚æ— ç”¨æˆ·æ•°æ®' +
                        '</td>' +
                        '</tr>';
                    return;
                }
                
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    const row = document.createElement('tr');
                    row.innerHTML = '<td>' + user.phone + '</td>' +
                        '<td>' + (user.user_name || 'æœªè®¾ç½®') + '</td>' +
                        '<td>' +
                        '<span class="level-badge level-' + user.level + '">' +
                        getLevelText(user.level) +
                        '</span>' +
                        '</td>' +
                        '<td>' + user.total_quota + '</td>' +
                        '<td>' + user.used_quota + '</td>' +
                        '<td>' + (user.total_quota - user.used_quota) + '</td>' +
                        '<td>' + formatDate(user.created_at) + '</td>' +
                        '<td>' +
                        '<button class="btn-table btn-edit" onclick="editUserQuota(' + user.id + ', ' + user.total_quota + ')">' +
                        'ä¿®æ”¹é¢åº¦' +
                        '</button>' +
                        '<button class="btn-table ' + (user.disabled ? 'btn-edit' : 'btn-disable') + '" ' +
                        'onclick="toggleUserStatus(' + user.id + ', ' + user.disabled + ')">' +
                        (user.disabled ? 'å¯ç”¨' : 'åœç”¨') +
                        '</button>' +
                        '<button class="btn-table btn-edit" onclick="editUserName(' + user.id + ', \'' + (user.user_name || '') + '\')">' +
                        'æ”¹å' +
                        '</button>' +
                        '</td>';
                    tbody.appendChild(row);
                }
                
                showToast('åŠ è½½æˆåŠŸï¼Œå…± ' + users.length + ' ä¸ªç”¨æˆ·', 'success');
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·é¢åº¦
        // ========================================
        async function editUserQuota(userId, currentQuota) {
            const newQuota = prompt('è¯·è¾“å…¥æ–°çš„æ€»é¢åº¦:', currentQuota);
            
            if (newQuota === null) return;
            
            if (!/^\d+$/.test(newQuota)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'error');
                return;
            }
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ total_quota: parseInt(newQuota) })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                showToast('ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåœç”¨/å¯ç”¨ç”¨æˆ·
        // ========================================
        async function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? 'å¯ç”¨' : 'åœç”¨';
            
            if (!confirm('ç¡®å®šè¦' + action + 'è¯¥ç”¨æˆ·å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ disabled: !currentStatus })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                showToast('å·²' + action + 'ç”¨æˆ·', 'success');
                loadAdminData();
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·å
        // ========================================
        async function editUserName(userId, currentName) {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å:', currentName);
            
            if (newName === null || newName.trim() === '') return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ user_name: newName.trim() })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                showToast('ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
        }

        // ========================================
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        // ========================================
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€...');
            console.log('Supabaseé…ç½®:', SUPABASE_CONFIG);
            
            // æ£€æŸ¥Excelåº“æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof XLSX === 'undefined') {
                console.error('Excelåº“åŠ è½½å¤±è´¥ï¼');
                showToast('Excelåº“åŠ è½½å¤±è´¥ï¼Œå¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨', 'error');
            } else {
                console.log('Excelåº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', XLSX.version);
            }
            
            if (authToken && authToken !== 'admin') {
                try {
                    const result = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', parseInt(authToken))
                        .single();
                    
                    if (!result.error && result.data && !result.data.disabled) {
                        currentUser = result.data;
                        document.getElementById('unifiedLoginContainer').style.display = 'none';
                        document.getElementById('userInterface').classList.add('active');
                        updateUserPanel();
                        addQueryRow();
                        console.log('ç”¨æˆ·è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                    } else {
                        localStorage.removeItem('authToken');
                        authToken = null;
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
                    localStorage.removeItem('authToken');
                    authToken = null;
                }
            } else if (authToken === 'admin') {
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('adminInterface').classList.add('active');
                loadAdminData();
                console.log('ç®¡ç†å‘˜è‡ªåŠ¨ç™»å½•æˆåŠŸ');
            }
        });

        // ========================================
        // å®šæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯30ç§’ï¼‰
        // ========================================
        setInterval(function() {
            if (currentUser && authToken && authToken !== 'admin') {
                refreshUserInfo();
            }
        }, 30000);

        // ========================================
        // æ–°å¢ï¼šé”®ç›˜å¿«æ·é”®æ”¯æŒ
        // ========================================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + E: å¯¼å‡ºExcel
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    exportToExcel();
                }
            }
            
            // Ctrl/Cmd + N: æ·»åŠ æ–°è¡Œ
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    addQueryRow();
                }
            }
            
            // Ctrl/Cmd + B: æ‰¹é‡æŸ¥è¯¢
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    batchQuery();
                }
            }
        });

        console.log('å¿«é€’æŸ¥è¯¢ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
        console.log('âœ… åŠŸèƒ½åˆ—è¡¨ï¼š');
        console.log('  - ç”¨æˆ·ç™»å½•/æ³¨å†Œ');
        console.log('  - å¿«é€’æŸ¥è¯¢');
        console.log('  - æ‰¹é‡æŸ¥è¯¢');
        console.log('  - å¯¼å‡ºExcel');
        console.log('  - ç®¡ç†å‘˜åå°');
        console.log('ğŸ“Œ å¿«æ·é”®ï¼š');
        console.log('  - Ctrl/Cmd + E: å¯¼å‡ºExcel');
        console.log('  - Ctrl/Cmd + N: æ·»åŠ æŸ¥è¯¢');
        console.log('  - Ctrl/Cmd + B: æ‰¹é‡æŸ¥è¯¢');
    </script>
</body>
</html>
