<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- å¼•å…¥SheetJSç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ========================================
           ç»Ÿä¸€ç™»å½•ç•Œé¢æ ·å¼
           ======================================== */
        
        #unifiedLoginContainer {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            margin: 100px auto;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-title {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        /* ========================================
           ç”¨æˆ·ç•Œé¢å’Œç®¡ç†å‘˜ç•Œé¢æ ·å¼
           ======================================== */
        
        #userInterface,
        #adminInterface {
            display: none;
        }

        #userInterface.active,
        #adminInterface.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            font-weight: 700;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-recharge {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-recharge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.5);
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ·ä¿¡æ¯é¢æ¿ */
        .user-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .user-info-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
        }

        .user-info-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .user-info-value {
            font-size: 22px;
            color: #333;
            font-weight: 700;
        }

        /* æŸ¥è¯¢åŒºåŸŸ */
        .query-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .btn-batch {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-history {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .action-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* æŸ¥è¯¢è¡¨æ ¼ */
        .query-table,
        .admin-table,
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .query-table th,
        .admin-table th,
        .history-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .query-table td,
        .admin-table td,
        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .query-table input,
        .admin-table input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .query-table input:focus,
        .admin-table input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* æŸ¥è¯¢çŠ¶æ€æ ‡ç­¾ */
        .query-status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .query-status-pending {
            background: #f8f9fa;
            color: #999;
        }

        .query-status-querying {
            background: #fff3cd;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .query-status-success {
            background: #d4edda;
            color: #155724;
        }

        .query-status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        /* å¿«é€’çŠ¶æ€ */
        .express-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .express-status.status-ACCEPT {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .express-status.status-TRANSPORT {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .express-status.status-DELIVERING {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .express-status.status-SIGN {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .express-status.status-PROBLEM,
        .express-status.status-FAILED {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .express-status.status-RETURNED {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .express-status:not([class*="status-"]) {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-query {
            padding: 6px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-query:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-query.btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-query.btn-detail {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .btn-query.btn-requery {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* ç‰©æµè¯¦æƒ…è¡Œ */
        .logistics-detail-row td {
            padding: 0 !important;
            background: #f8f9fa;
        }

        .logistics-details {
            padding: 25px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .logistics-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logistics-header-left {
            flex: 1;
        }

        .logistics-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .logistics-company {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .company-logo {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: contain;
        }

        .company-name {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .logistics-meta {
            font-size: 13px;
            color: #999;
            margin-top: 5px;
        }

        .courier-info {
            color: #666;
            font-weight: 600;
        }

        .logistics-header-right {
            text-align: right;
        }

        .logistics-info-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .info-row {
            display: flex;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: #999;
            min-width: 80px;
            font-weight: 600;
        }

        .info-value {
            color: #333;
            flex: 1;
        }

        .logistics-timeline {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logistics-item {
            display: flex;
            padding: 15px 0;
            border-left: 3px solid #667eea;
            padding-left: 20px;
            position: relative;
            margin-left: 10px;
        }

        .logistics-item:before {
            content: '';
            position: absolute;
            left: -7px;
            top: 20px;
            width: 11px;
            height: 11px;
            background: #667eea;
            border-radius: 50%;
            box-shadow: 0 0 0 3px white, 0 0 0 5px #667eea;
        }

        .logistics-item:first-child:before {
            background: #2ecc71;
            box-shadow: 0 0 0 3px white, 0 0 0 5px #2ecc71;
        }

        .logistics-time {
            min-width: 150px;
            color: #999;
            font-size: 13px;
            font-weight: 600;
        }

        .logistics-content {
            flex: 1;
            color: #333;
            font-size: 14px;
            line-height: 1.6;
        }

        .logistics-area {
            color: #667eea;
            font-size: 12px;
            margin-top: 5px;
        }

        .logistics-empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ç®¡ç†å‘˜è¡¨æ ¼æ ·å¼ */
        .btn-table {
            padding: 5px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-table.btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-table.btn-disable {
            background: #e74c3c;
            color: white;
        }

        .btn-table:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .level-badge.level-trial {
            background: #f8f9fa;
            color: #999;
        }

        .level-badge.level-gold {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .level-badge.level-platinum {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            border-left: 4px solid #2ecc71;
            color: #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        .toast.success:before {
            content: 'âœ“';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #2ecc71;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
        }

        .toast.error:before {
            content: 'âœ—';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        /* å†å²è®°å½•åŒºåŸŸæ ·å¼ */
        .history-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .history-section.active {
            display: block;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: white;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .stat-card.failed {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .history-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .history-empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .history-empty-text {
            font-size: 18px;
            color: #666;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .history-empty-hint {
            font-size: 14px;
            color: #999;
        }

        /* ç®€åŒ–å……å€¼å¼¹çª—æ ·å¼ */
        .recharge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .recharge-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .recharge-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .recharge-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .recharge-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .recharge-message {
            font-size: 16px;
            color: #666;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .recharge-contact {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        .contact-icon {
            font-size: 20px;
        }

        .recharge-close-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .recharge-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            #unifiedLoginContainer {
                padding: 40px 20px;
                margin: 50px auto;
            }

            .login-title {
                font-size: 24px;
            }

            .user-panel {
                grid-template-columns: 1fr;
            }

            .query-table, .admin-table, .history-table {
                font-size: 12px;
            }

            .query-table th, .query-table td,
            .admin-table th, .admin-table td,
            .history-table th, .history-table td {
                padding: 8px;
            }

            .logistics-header {
                flex-direction: column;
            }

            .logistics-header-right {
                text-align: left;
                margin-top: 10px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }

            .history-stats {
                grid-template-columns: 1fr;
            }

            .history-filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€ç™»å½•ç•Œé¢ -->
        <div id="unifiedLoginContainer">
            <h1 class="login-title">ğŸ“¦ å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</h1>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchLoginTab('user')">ç”¨æˆ·ç™»å½•</button>
                <button class="tab-btn" onclick="switchLoginTab('admin')">ç®¡ç†å‘˜ç™»å½•</button>
            </div>

            <!-- ç”¨æˆ·ç™»å½•è¡¨å• -->
            <div id="userLoginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginUserPhone">æ‰‹æœºå·</label>
                    <input type="tel" id="loginUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                </div>
                <button class="login-btn" onclick="handleUserLogin()">ç™»å½• / æ³¨å†Œ</button>
                <p style="margin-top: 15px; color: #999; font-size: 14px;">
                    æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•è‡ªåŠ¨æ³¨å†Œï¼Œèµ é€1æ¬¡è¯•ç”¨é¢åº¦
                </p>
            </div>

            <!-- ç®¡ç†å‘˜ç™»å½•è¡¨å• -->
            <div id="adminLoginForm" class="login-form">
                <div class="form-group">
                    <label for="adminUsername">ç®¡ç†å‘˜è´¦å·</label>
                    <input type="text" id="adminUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
                </div>
                <div class="form-group">
                    <label for="adminPassword">å¯†ç </label>
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button class="login-btn" onclick="handleAdminLogin()">ç™»å½•</button>
                <p style="margin-top: 15px; color: #999; font-size: 14px;">
                    é»˜è®¤è´¦å·ï¼šadmin / å¯†ç ï¼šadmin123
                </p>
            </div>
        </div>

        <!-- ç”¨æˆ·ç•Œé¢ -->
        <div id="userInterface">
            <div class="header">
                <h1>ç”¨æˆ·ä¸­å¿ƒ</h1>
                <div class="header-buttons">
                    <button class="btn-recharge" onclick="openRechargeModal()">ğŸ’° å……å€¼</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
            <div class="user-panel">
                <div class="user-info-item">
                    <div class="user-info-label">æ‰‹æœºå·</div>
                    <div class="user-info-value" id="userPhone">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ç”¨æˆ·å</div>
                    <div class="user-info-value" id="userName">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ä¼šå‘˜ç­‰çº§</div>
                    <div class="user-info-value" id="userLevel">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">æ€»é¢åº¦</div>
                    <div class="user-info-value" id="totalQuota">0</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">å·²ä½¿ç”¨</div>
                    <div class="user-info-value" id="usedQuota">0</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">å‰©ä½™é¢åº¦</div>
                    <div class="user-info-value" id="remainQuota">0</div>
                </div>
            </div>

            <!-- å¿«é€’æŸ¥è¯¢åŒºåŸŸ -->
            <div class="query-section">
                <h2 class="section-title">å¿«é€’æŸ¥è¯¢</h2>
                
                <!-- æ“ä½œæŒ‰é’®ç»„ -->
                <div class="action-buttons">
                    <button class="btn-add" onclick="showQuerySection()">â• æ·»åŠ æŸ¥è¯¢</button>
                    <button class="btn-export" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                    <button class="btn-batch" onclick="batchQuery()">ğŸš€ æ‰¹é‡æŸ¥è¯¢</button>
                    <button class="btn-clear" onclick="clearAllRows()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                    <button class="btn-history" onclick="showHistorySection()">ğŸ“œ æŸ¥è¯¢å†å²</button>
                </div>
                
                <!-- æŸ¥è¯¢è¡¨æ ¼åŒºåŸŸ -->
                <div id="querySection" class="query-content">
                    <table class="query-table">
                        <thead>
                            <tr>
                                <th style="width: 25%">å¿«é€’å•å·</th>
                                <th style="width: 15%">æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰</th>
                                <th style="width: 12%">æŸ¥è¯¢çŠ¶æ€</th>
                                <th style="width: 15%">å¿«é€’çŠ¶æ€</th>
                                <th style="width: 15%">å¿«é€’å…¬å¸</th>
                                <th style="width: 18%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="queryTableBody"></tbody>
                    </table>
                </div>

                <!-- å†å²è®°å½•åŒºåŸŸ -->
                <div id="historySection" class="history-section">
                    <div class="history-stats">
                        <div class="stat-card">
                            <div class="stat-label">æ€»æŸ¥è¯¢æ¬¡æ•°</div>
                            <div class="stat-value" id="historyTotalCount">0</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-label">æˆåŠŸæ¬¡æ•°</div>
                            <div class="stat-value" id="historySuccessCount">0</div>
                        </div>
                        <div class="stat-card failed">
                            <div class="stat-label">å¤±è´¥æ¬¡æ•°</div>
                            <div class="stat-value" id="historyFailedCount">0</div>
                        </div>
                    </div>

                    <div class="history-filters">
                        <div class="filter-group">
                            <label>å¿«é€’å•å·ï¼š</label>
                            <input type="text" id="filterExpressNumber" placeholder="è¾“å…¥å•å·æœç´¢">
                        </div>
                        <div class="filter-group">
                            <label>å¿«é€’å…¬å¸ï¼š</label>
                            <input type="text" id="filterCompany" placeholder="è¾“å…¥å…¬å¸å">
                        </div>
                        <div class="filter-group">
                            <label>çŠ¶æ€ï¼š</label>
                            <select id="filterStatus">
                                <option value="">å…¨éƒ¨</option>
                                <option value="success">æˆåŠŸ</option>
                                <option value="failed">å¤±è´¥</option>
                            </select>
                        </div>
                        <button class="btn-query" onclick="filterHistory()">ğŸ” æœç´¢</button>
                        <button class="btn-export" onclick="exportHistoryToExcel()">ğŸ“Š å¯¼å‡ºå†å²</button>
                    </div>

                    <table class="history-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">æŸ¥è¯¢æ—¶é—´</th>
                                <th style="width: 18%">å¿«é€’å•å·</th>
                                <th style="width: 12%">æ‰‹æœºå·</th>
                                <th style="width: 12%">å¿«é€’å…¬å¸</th>
                                <th style="width: 13%">å¿«é€’çŠ¶æ€</th>
                                <th style="width: 10%">æŸ¥è¯¢çŠ¶æ€</th>
                                <th style="width: 20%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ç•Œé¢ -->
        <div id="adminInterface">
            <div class="header">
                <h1>ç®¡ç†å‘˜åå°</h1>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <div class="query-section">
                <h2 class="section-title">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                
                <div class="action-buttons">
                    <button class="btn-export" onclick="exportUsersToExcel()">ğŸ“Š å¯¼å‡ºç”¨æˆ·æ•°æ®</button>
                    <button class="btn-export" onclick="exportAllLogsToExcel()">ğŸ“‹ å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—</button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>æ‰‹æœºå·</th>
                            <th>ç”¨æˆ·å</th>
                            <th>ä¼šå‘˜ç­‰çº§</th>
                            <th>æ€»é¢åº¦</th>
                            <th>å·²ä½¿ç”¨</th>
                            <th>å‰©ä½™é¢åº¦</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç®€åŒ–å……å€¼å¼¹çª— -->
    <div id="rechargeModal" class="recharge-modal">
        <div class="recharge-content">
            <div class="recharge-icon">ğŸ’°</div>
            <h2 class="recharge-title">å……å€¼æé†’</h2>
            <p class="recharge-message">
                å¦‚éœ€å……å€¼ï¼Œè¯·è”ç³»ç®¡ç†å‘˜<br>
                ç®¡ç†å‘˜å°†ä¸ºæ‚¨æ‰‹åŠ¨æ·»åŠ æŸ¥è¯¢é¢åº¦
            </p>
            <div class="recharge-contact">
                <div class="contact-item">
                    <span class="contact-icon">ğŸ“</span>
                    <span>è”ç³»ç”µè¯ï¼š138-xxxx-xxxx</span>
                </div>
                <div class="contact-item">
                    <span class="contact-icon">ğŸ’¬</span>
                    <span>å¾®ä¿¡å·ï¼šadmin_express</span>
                </div>
                <div class="contact-item">
                    <span class="contact-icon">ğŸ“§</span>
                    <span>é‚®ç®±ï¼šadmin@express.com</span>
                </div>
            </div>
            <button class="recharge-close-btn" onclick="closeRechargeModal()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†ä¸­...</div>
        </div>
    </div>

    <script>
        // ========================================
        // å…¨å±€å˜é‡å£°æ˜ï¼ˆå…ˆå£°æ˜ï¼Œååˆå§‹åŒ–ï¼‰
        // ========================================
        let supabaseClient = null;
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let queryRowCounter = 0;
        let queryDataCache = {};
        let historyData = [];
        let filteredHistoryData = [];

        // ========================================
        // Supabase é…ç½®ï¼ˆé‡è¦ï¼šæ›¿æ¢ä¸ºä½ çš„å®é™…é…ç½®ï¼‰
        // ========================================
        const SUPABASE_CONFIG = {
            url: 'https://pukyydqtctlvexbndvep.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1a3l5ZHF0Y3RsdmV4Ym5kdmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzQ0MjIsImV4cCI6MjA4MjQxMDQyMn0.1u5yf_3RJWgoJxxMg-CsYZViraJjreMXRH3XBslJaco'
        };

        // é˜¿é‡Œäº‘å¿«é€’æŸ¥è¯¢APIé…ç½®
        const ALIYUN_APPCODE = '8c02c90948e246a994147ed55109955c';

        // ========================================
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
        // ========================================
        function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    console.error('âŒ Supabase åº“æœªåŠ è½½ï¼');
                    showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    return false;
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
                return false;
            }
        }

        // ========================================
        // æ£€æŸ¥ Supabase æ˜¯å¦å·²åˆå§‹åŒ–
        // ========================================
        function checkSupabaseInit() {
            if (!supabaseClient) {
                console.error('âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼');
                showToast('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                return false;
            }
            return true;
        }
        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        // ========================================
        function showLoading(text) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (text) loadingText.textContent = text;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯
        // ========================================
        function showToast(message, type) {
            type = type || 'success';
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(function() {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(function() {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³
        // ========================================
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
        }

        // ========================================
        // è·å–ä¼šå‘˜ç­‰çº§æ–‡æœ¬
        // ========================================
        function getLevelText(level) {
            const levels = {
                'trial': 'è¯•ç”¨ä¼šå‘˜',
                'gold': 'é»„é‡‘ä¼šå‘˜',
                'platinum': 'é“‚é‡‘ä¼šå‘˜'
            };
            return levels[level] || level;
        }

        // ========================================
        // ç™»å½•ç•Œé¢ï¼šåˆ‡æ¢æ ‡ç­¾é¡µ
        // ========================================
        function switchLoginTab(type) {
            const userTab = document.querySelector('.tab-btn:first-child');
            const adminTab = document.querySelector('.tab-btn:last-child');
            const userForm = document.getElementById('userLoginForm');
            const adminForm = document.getElementById('adminLoginForm');

            if (type === 'user') {
                userTab.classList.add('active');
                adminTab.classList.remove('active');
                userForm.classList.add('active');
                adminForm.classList.remove('active');
            } else {
                adminTab.classList.add('active');
                userTab.classList.remove('active');
                adminForm.classList.add('active');
                userForm.classList.remove('active');
            }
        }

        // ========================================
        // ç”¨æˆ·ç™»å½•/æ³¨å†Œ
        // ========================================
        async function handleUserLogin() {
            if (!checkSupabaseInit()) return;
            
            const phone = document.getElementById('loginUserPhone').value.trim();
            
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ç™»å½•...');
                
                const queryResult = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                const existUser = queryResult.data;
                const queryError = queryResult.error;
                
                if (queryError && queryError.code !== 'PGRST116') {
                    throw queryError;
                }
                
                if (!existUser) {
                    const insertResult = await supabaseClient
                        .from('users')
                        .insert([{
                            phone: phone,
                            user_name: 'æ–°ç”¨æˆ·',
                            avatar: 'color-1',
                            level: 'trial',
                            total_quota: 1,
                            used_quota: 0,
                            disabled: false
                        }])
                        .select()
                        .single();
                    
                    if (insertResult.error) throw insertResult.error;
                    
                    currentUser = insertResult.data;
                    hideLoading();
                    showToast('æ³¨å†ŒæˆåŠŸï¼èµ é€1æ¬¡è¯•ç”¨é¢åº¦', 'success');
                } else {
                    if (existUser.disabled) {
                        hideLoading();
                        showToast('è´¦æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                        return;
                    }
                    currentUser = existUser;
                    hideLoading();
                    showToast('ç™»å½•æˆåŠŸï¼', 'success');
                }
                
                authToken = currentUser.id.toString();
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('userInterface').classList.add('active');
                
                updateUserPanel();
                showQuerySection();
                addQueryRow();
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                hideLoading();
                showToast('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ç™»å½•
        // ========================================
        async function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!username || !password) {
                showToast('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }
            
            if (username === 'admin' && password === 'admin123') {
                authToken = 'admin';
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('adminInterface').classList.add('active');
                
                loadAdminData();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
            } else {
                showToast('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
            }
        }

        // ========================================
        // é€€å‡ºç™»å½•
        // ========================================
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            queryDataCache = {};
            historyData = [];
            filteredHistoryData = [];
            
            document.getElementById('userInterface').classList.remove('active');
            document.getElementById('adminInterface').classList.remove('active');
            document.getElementById('unifiedLoginContainer').style.display = 'block';
            
            document.getElementById('loginUserPhone').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('queryTableBody').innerHTML = '';
            queryRowCounter = 0;
            
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        // ========================================
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯é¢æ¿
        // ========================================
        function updateUserPanel() {
            if (!currentUser) return;
            
            document.getElementById('userPhone').textContent = currentUser.phone;
            document.getElementById('userName').textContent = currentUser.user_name || 'æ–°ç”¨æˆ·';
            document.getElementById('userLevel').textContent = getLevelText(currentUser.level);
            document.getElementById('totalQuota').textContent = currentUser.total_quota;
            document.getElementById('usedQuota').textContent = currentUser.used_quota;
            document.getElementById('remainQuota').textContent = currentUser.total_quota - currentUser.used_quota;
        }

        // ========================================
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        // ========================================
        async function refreshUserInfo() {
            if (!checkSupabaseInit()) return;
            if (!authToken || authToken === 'admin') return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', parseInt(authToken))
                    .single();
                
                if (result.error) throw result.error;
                
                currentUser = result.data;
                updateUserPanel();
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            }
        }

        // ========================================
        // ç®€åŒ–å……å€¼åŠŸèƒ½
        // ========================================
        function openRechargeModal() {
            document.getElementById('rechargeModal').classList.add('active');
        }

        function closeRechargeModal() {
            document.getElementById('rechargeModal').classList.remove('active');
        }

        // ========================================
        // åˆ‡æ¢åˆ°æŸ¥è¯¢åŒºåŸŸ
        // ========================================
        function showQuerySection() {
            document.getElementById('querySection').style.display = 'block';
            document.getElementById('historySection').classList.remove('active');
        }

        // ========================================
        // åˆ‡æ¢åˆ°å†å²è®°å½•åŒºåŸŸ
        // ========================================
        async function showHistorySection() {
            document.getElementById('querySection').style.display = 'none';
            document.getElementById('historySection').classList.add('active');
            await loadHistoryData();
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šåŠ è½½å†å²æ•°æ®
        // ========================================
        async function loadHistoryData() {
            if (!checkSupabaseInit()) return;
            if (!currentUser) return;
            
            try {
                showLoading('æ­£åœ¨åŠ è½½å†å²è®°å½•...');
                
                const result = await supabaseClient
                    .from('query_logs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('query_time', { ascending: false })
                    .limit(500);
                
                if (result.error) throw result.error;
                
                historyData = result.data || [];
                filteredHistoryData = historyData;
                
                updateHistoryStats();
                renderHistoryTable();
                
                hideLoading();
                
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                hideLoading();
                showToast('åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šæ›´æ–°ç»Ÿè®¡æ•°æ®
        // ========================================
        function updateHistoryStats() {
            const totalCount = filteredHistoryData.length;
            const successCount = filteredHistoryData.filter(item => item.status === 'success').length;
            const failedCount = filteredHistoryData.filter(item => item.status === 'failed').length;
            
            document.getElementById('historyTotalCount').textContent = totalCount;
            document.getElementById('historySuccessCount').textContent = successCount;
            document.getElementById('historyFailedCount').textContent = failedCount;
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šæ¸²æŸ“å†å²è®°å½•è¡¨æ ¼
        // ========================================
        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (filteredHistoryData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">' +
                    '<div class="history-empty">' +
                    '<div class="history-empty-icon">ğŸ“­</div>' +
                    '<div class="history-empty-text">æš‚æ— æŸ¥è¯¢è®°å½•</div>' +
                    '<div class="history-empty-hint">å¼€å§‹æŸ¥è¯¢å¿«é€’ï¼Œè®°å½•å°†è‡ªåŠ¨ä¿å­˜</div>' +
                    '</div>' +
                    '</td></tr>';
                return;
            }
            
            for (let i = 0; i < filteredHistoryData.length; i++) {
                const item = filteredHistoryData[i];
                const row = document.createElement('tr');
                row.setAttribute('data-history-index', i);
                
                let statusCode = '';
                let expressStatusHTML = '-';
                
                if (item.express_status) {
                    if (item.logistics_data) {
                        try {
                            const logisticsData = typeof item.logistics_data === 'string' ? 
                                JSON.parse(item.logistics_data) : item.logistics_data;
                            statusCode = logisticsData.status_code || '';
                        } catch (e) {
                            console.error('è§£æç‰©æµæ•°æ®å¤±è´¥:', e);
                        }
                    }
                    
                    expressStatusHTML = '<span class="express-status status-' + statusCode + '">' + 
                        item.express_status + '</span>';
                } else {
                    expressStatusHTML = '<span style="color: #999;">-</span>';
                }
                
                const statusClass = item.status === 'success' ? 'query-status-success' : 'query-status-failed';
                const statusText = item.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                
                row.innerHTML = 
                    '<td>' + formatDate(item.query_time || item.created_at) + '</td>' +
                    '<td>' + (item.express_number || '-') + '</td>' +
                    '<td>' + (item.mobile || '-') + '</td>' +
                    '<td>' + (item.company_name || '-') + '</td>' +
                    '<td>' + expressStatusHTML + '</td>' +
                    '<td><span class="query-status-badge ' + statusClass + '">' + statusText + '</span></td>' +
                    '<td>' +
                    (item.logistics_data ? 
                        '<button class="btn-query btn-detail" onclick="showHistoryDetail(' + i + ')">è¯¦æƒ…</button>' : '') +
                    '<button class="btn-query btn-requery" onclick="requeryFromHistory(' + i + ')">å†æ¬¡æŸ¥è¯¢</button>' +
                    '<button class="btn-query btn-delete" onclick="deleteHistoryRecord(' + i + ')">åˆ é™¤</button>' +
                    '</td>';
                
                tbody.appendChild(row);
            }
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šç­›é€‰å†å²è®°å½•
        // ========================================
        function filterHistory() {
            const expressNumber = document.getElementById('filterExpressNumber').value.trim().toLowerCase();
            const company = document.getElementById('filterCompany').value.trim().toLowerCase();
            const status = document.getElementById('filterStatus').value;
            
            filteredHistoryData = historyData.filter(function(item) {
                let match = true;
                
                if (expressNumber && item.express_number) {
                    match = match && item.express_number.toLowerCase().includes(expressNumber);
                }
                
                if (company && item.company_name) {
                    match = match && item.company_name.toLowerCase().includes(company);
                }
                
                if (status) {
                    match = match && item.status === status;
                }
                
                return match;
            });
            
            updateHistoryStats();
            renderHistoryTable();
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šæ˜¾ç¤ºå†å²è¯¦æƒ…
        // ========================================
        function showHistoryDetail(index) {
            const item = filteredHistoryData[index];
            
            if (!item.logistics_data) {
                showToast('æš‚æ— ç‰©æµè¯¦æƒ…', 'error');
                return;
            }
            
            try {
                const data = typeof item.logistics_data === 'string' ? 
                    JSON.parse(item.logistics_data) : item.logistics_data;
                
                const tbody = document.getElementById('historyTableBody');
                const rows = tbody.querySelectorAll('tr[data-history-index]');
                let currentRow = null;
                
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i].getAttribute('data-history-index') === index.toString()) {
                        currentRow = rows[i];
                        break;
                    }
                }
                
                if (!currentRow) return;
                
                const nextRow = currentRow.nextElementSibling;
                if (nextRow && nextRow.classList && nextRow.classList.contains('logistics-detail-row')) {
                    nextRow.remove();
                    return;
                }
                
                const detailRow = document.createElement('tr');
                detailRow.className = 'logistics-detail-row';
                
                const detailCell = document.createElement('td');
                detailCell.colSpan = 7;
                detailCell.innerHTML = generateLogisticsDetailHTML(data);
                
                detailRow.appendChild(detailCell);
                currentRow.parentNode.insertBefore(detailRow, currentRow.nextSibling);
                
            } catch (error) {
                console.error('æ˜¾ç¤ºè¯¦æƒ…å¤±è´¥:', error);
                showToast('æ˜¾ç¤ºè¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šå†æ¬¡æŸ¥è¯¢
        // ========================================
        async function requeryFromHistory(index) {
            const item = filteredHistoryData[index];
            
            if (!item.express_number) {
                showToast('å¿«é€’å•å·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (currentUser.total_quota - currentUser.used_quota <= 0) {
                showToast('æŸ¥è¯¢é¢åº¦ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•', 'error');
                openRechargeModal();
                return;
            }
            
            if (!confirm('ç¡®å®šè¦å†æ¬¡æŸ¥è¯¢å¿«é€’å•å· ' + item.express_number + ' å—ï¼Ÿ\nå°†æ¶ˆè€—1æ¬¡æŸ¥è¯¢é¢åº¦')) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨æŸ¥è¯¢ä¸­...');
                
                const formData = new URLSearchParams();
                formData.append('number', item.express_number);
                if (item.mobile) {
                    formData.append('mobile', item.mobile);
                }
                formData.append('expressCode', '');
                
                const response = await fetch('https://jmexpresv2.market.alicloudapi.com/express/query-v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'APPCODE ' + ALIYUN_APPCODE,
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: formData.toString()
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    const data = result.data;
                    
                    const unifiedData = {
                        express_number: data.number,
                        company: data.expressCompanyName,
                        company_code: data.expressCode,
                        company_logo: data.expressCompanyLogo,
                        status: data.logisticsStatusDesc,
                        status_code: data.logisticsStatus,
                        latest_message: data.theLastMessage,
                        latest_time: data.theLastTime,
                        take_time: data.takeTime,
                        courier: data.courier,
                        courier_phone: data.courierPhone,
                        list: []
                    };
                    
                    if (data.logisticsTraceDetails && data.logisticsTraceDetails.length > 0) {
                        unifiedData.list = data.logisticsTraceDetails.map(function(item) {
                            return {
                                time: formatTimestamp(item.time),
                                status: item.desc,
                                context: item.desc,
                                location: item.areaName || '',
                                area: item.areaName || '',
                                status_code: item.logisticsStatus,
                                sub_status_code: item.subLogisticsStatus
                            };
                        });
                    }
                    
                    await updateUserQuota();
                    await logQuery(
                        item.express_number,
                        item.mobile || '',
                        data.expressCompanyName,
                        'success',
                        data.logisticsStatusDesc,
                        unifiedData
                    );
                    
                    hideLoading();
                    showToast('æŸ¥è¯¢æˆåŠŸï¼', 'success');
                    await loadHistoryData();
                    
                } else {
                    hideLoading();
                    showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'), 'error');
                    await logQuery(item.express_number, item.mobile || '', '', 'failed', result.msg || '', null);
                }
                
            } catch (error) {
                console.error('å†æ¬¡æŸ¥è¯¢å¤±è´¥:', error);
                hideLoading();
                showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šåˆ é™¤å†å²è®°å½•
        // ========================================
        async function deleteHistoryRecord(index) {
            if (!checkSupabaseInit()) return;
            
            const item = filteredHistoryData[index];
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æŸ¥è¯¢è®°å½•å—ï¼Ÿ\nå¿«é€’å•å·ï¼š' + (item.express_number || 'æœªçŸ¥'))) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨åˆ é™¤...');
                
                const result = await supabaseClient
                    .from('query_logs')
                    .delete()
                    .eq('id', item.id);
                
                if (result.error) throw result.error;
                
                hideLoading();
                showToast('åˆ é™¤æˆåŠŸï¼', 'success');
                await loadHistoryData();
                
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                hideLoading();
                showToast('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // å†å²è®°å½•åŠŸèƒ½ï¼šå¯¼å‡ºå†å²è®°å½•åˆ°Excel
        // ========================================
        async function exportHistoryToExcel() {
            if (filteredHistoryData.length === 0) {
                showToast('æš‚æ— å†å²è®°å½•å¯å¯¼å‡º', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶...');
                
                const wb = XLSX.utils.book_new();
                
                const summaryData = [];
                summaryData.push(['æŸ¥è¯¢å†å²è®°å½•å¯¼å‡º']);
                summaryData.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                summaryData.push(['ç”¨æˆ·', currentUser.user_name + ' (' + currentUser.phone + ')']);
                summaryData.push(['è®°å½•æ€»æ•°', filteredHistoryData.length + ' æ¡']);
                summaryData.push([]);
                summaryData.push(['æŸ¥è¯¢æ—¶é—´', 'å¿«é€’å•å·', 'æ‰‹æœºå·', 'å¿«é€’å…¬å¸', 'å¿«é€’çŠ¶æ€', 'æŸ¥è¯¢çŠ¶æ€']);
                
                for (let i = 0; i < filteredHistoryData.length; i++) {
                    const item = filteredHistoryData[i];
                    summaryData.push([
                        formatDate(item.query_time || item.created_at),
                        item.express_number || '',
                        item.mobile || '',
                        item.company_name || '',
                        item.express_status || '',
                        item.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'
                    ]);
                }
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [
                    { wch: 20 }, { wch: 20 }, { wch: 15 }, 
                    { wch: 15 }, { wch: 15 }, { wch: 10 }
                ];
                
                XLSX.utils.book_append_sheet(wb, summaryWs, 'æŸ¥è¯¢æ¦‚è§ˆ');
                
                let detailSheetCount = 0;
                
                for (let i = 0; i < filteredHistoryData.length; i++) {
                    const item = filteredHistoryData[i];
                    
                    if (!item.logistics_data) continue;
                    
                    try {
                        const logisticsData = typeof item.logistics_data === 'string' ? 
                            JSON.parse(item.logistics_data) : item.logistics_data;
                        
                        const detailData = [];
                        detailData.push(['å¿«é€’è¯¦ç»†ä¿¡æ¯']);
                        detailData.push(['æŸ¥è¯¢æ—¶é—´', formatDate(item.query_time || item.created_at)]);
                        detailData.push(['å¿«é€’å•å·', logisticsData.express_number || item.express_number || '']);
                        detailData.push(['å¿«é€’å…¬å¸', logisticsData.company || item.company_name || '']);
                        detailData.push(['å¿«é€’çŠ¶æ€', logisticsData.status || item.express_status || '']);
                        
                        if (logisticsData.courier || logisticsData.courier_phone) {
                            detailData.push(['å¿«é€’å‘˜', logisticsData.courier || '']);
                            detailData.push(['è”ç³»ç”µè¯', logisticsData.courier_phone || '']);
                        }
                        
                        if (logisticsData.take_time) {
                            detailData.push(['é…é€è€—æ—¶', logisticsData.take_time]);
                        }
                        
                        detailData.push([]);
                        detailData.push(['ç‰©æµè½¨è¿¹']);
                        detailData.push(['æ—¶é—´', 'ç‰©æµä¿¡æ¯', 'æ‰€åœ¨åœ°']);
                        
                        const logisticsList = logisticsData.list || logisticsData.data || [];
                        if (logisticsList && logisticsList.length > 0) {
                            for (let j = 0; j < logisticsList.length; j++) {
                                const trace = logisticsList[j];
                                detailData.push([
                                    trace.time || '',
                                    trace.status || trace.context || trace.desc || '',
                                    trace.location || trace.area || trace.areaName || ''
                                ]);
                            }
                        } else {
                            detailData.push(['', 'æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯', '']);
                        }
                        
                        const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                        detailWs['!cols'] = [{ wch: 20 }, { wch: 60 }, { wch: 20 }];
                        
                        detailSheetCount++;
                        let sheetName = (logisticsData.express_number || item.express_number || 'å•å·' + detailSheetCount);
                        sheetName = sheetName.replace(/[:\\\/\?\*\[\]]/g, '').substring(0, 25);
                        
                        let finalSheetName = sheetName;
                        let suffix = 1;
                        while (wb.SheetNames.indexOf(finalSheetName) !== -1) {
                            finalSheetName = sheetName + '_' + suffix;
                            suffix++;
                        }
                        
                        XLSX.utils.book_append_sheet(wb, detailWs, finalSheetName);
                        
                    } catch (error) {
                        console.error('å¤„ç†ç‰©æµæ•°æ®å¤±è´¥:', error);
                        continue;
                    }
                }
                
                const fileName = 'æŸ¥è¯¢å†å²_' + currentUser.user_name + '_' + 
                    new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx';
                
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼\næ¦‚è§ˆè®°å½•ï¼š' + filteredHistoryData.length + ' æ¡\nè¯¦ç»†ç‰©æµï¼š' + detailSheetCount + ' ä¸ª', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šæ·»åŠ æŸ¥è¯¢è¡Œ
        // ========================================
        function addQueryRow() {
            queryRowCounter++;
            const tbody = document.getElementById('queryTableBody');
            const row = document.createElement('tr');
            row.id = 'queryRow-' + queryRowCounter;
            row.setAttribute('data-row-id', queryRowCounter);
            
            row.innerHTML = 
                '<td><input type="text" id="expressNumber-' + queryRowCounter + '" placeholder="è¯·è¾“å…¥å¿«é€’å•å·"></td>' +
                '<td><input type="tel" id="mobile-' + queryRowCounter + '" placeholder="é€‰å¡«" maxlength="11"></td>' +
                '<td><span class="query-status-badge query-status-pending">å¾…æŸ¥è¯¢</span></td>' +
                '<td>-</td>' +
                '<td>-</td>' +
                '<td>' +
                '<button class="btn-query" onclick="querySingleExpress(' + queryRowCounter + ')">æŸ¥è¯¢</button>' +
                '<button class="btn-query btn-delete" onclick="deleteQueryRow(' + queryRowCounter + ')">åˆ é™¤</button>' +
                '</td>';
            
            tbody.appendChild(row);
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šåˆ é™¤æŸ¥è¯¢è¡Œ
        // ========================================
        function deleteQueryRow(rowId) {
            const row = document.getElementById('queryRow-' + rowId);
            if (row) {
                row.remove();
                delete queryDataCache[rowId];
            }
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šæ¸…ç©ºæ‰€æœ‰è¡Œ
        // ========================================
        function clearAllRows() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            const tbody = document.getElementById('queryTableBody');
            tbody.innerHTML = '';
            queryDataCache = {};
            queryRowCounter = 0;
            showToast('å·²æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è®°å½•', 'success');
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šå•ä¸ªæŸ¥è¯¢
        // ========================================
        async function querySingleExpress(rowId) {
            const expressNumber = document.getElementById('expressNumber-' + rowId).value.trim();
            const mobile = document.getElementById('mobile-' + rowId).value.trim();
            
            if (!expressNumber) {
                showToast('è¯·è¾“å…¥å¿«é€’å•å·', 'error');
                return;
            }
            
            if (currentUser.total_quota - currentUser.used_quota <= 0) {
                showToast('æŸ¥è¯¢é¢åº¦ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•', 'error');
                openRechargeModal();
                return;
            }
            
            const row = document.getElementById('queryRow-' + rowId);
            const statusCell = row.cells[2];
            const expressStatusCell = row.cells[3];
            const companyCell = row.cells[4];
            const actionCell = row.cells[5];
            
            statusCell.innerHTML = '<span class="query-status-badge query-status-querying">æŸ¥è¯¢ä¸­...</span>';
            
            try {
                const formData = new URLSearchParams();
                formData.append('number', expressNumber);
                if (mobile) {
                    formData.append('mobile', mobile);
                }
                formData.append('expressCode', '');
                
                const response = await fetch('https://jmexpresv2.market.alicloudapi.com/express/query-v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'APPCODE ' + ALIYUN_APPCODE,
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: formData.toString()
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    const data = result.data;
                    
                    const unifiedData = {
                        express_number: data.number,
                        company: data.expressCompanyName,
                        company_code: data.expressCode,
                        company_logo: data.expressCompanyLogo,
                        status: data.logisticsStatusDesc,
                        status_code: data.logisticsStatus,
                        latest_message: data.theLastMessage,
                        latest_time: data.theLastTime,
                        take_time: data.takeTime,
                        courier: data.courier,
                        courier_phone: data.courierPhone,
                        list: []
                    };
                    
                    if (data.logisticsTraceDetails && data.logisticsTraceDetails.length > 0) {
                        unifiedData.list = data.logisticsTraceDetails.map(function(item) {
                            return {
                                time: formatTimestamp(item.time),
                                status: item.desc,
                                context: item.desc,
                                location: item.areaName || '',
                                area: item.areaName || '',
                                status_code: item.logisticsStatus,
                                sub_status_code: item.subLogisticsStatus
                            };
                        });
                    }
                    
                    queryDataCache[rowId] = unifiedData;
                    
                    statusCell.innerHTML = '<span class="query-status-badge query-status-success">æŸ¥è¯¢æˆåŠŸ</span>';
                    expressStatusCell.innerHTML = '<span class="express-status status-' + data.logisticsStatus + '">' + data.logisticsStatusDesc + '</span>';
                    companyCell.innerHTML = '<div style="display: flex; align-items: center; gap: 8px;">' +
                        (data.expressCompanyLogo ? '<img src="' + data.expressCompanyLogo + '" style="width: 20px; height: 20px; object-fit: contain;" alt="logo">' : '') +
                        '<span>' + data.expressCompanyName + '</span>' +
                        '</div>';
                    
                    actionCell.innerHTML = 
                        '<button class="btn-query btn-detail" onclick="showLogisticsDetail(' + rowId + ')">è¯¦æƒ…</button>' +
                        '<button class="btn-query btn-delete" onclick="deleteQueryRow(' + rowId + ')">åˆ é™¤</button>';
                    
                    await updateUserQuota();
                    await logQuery(expressNumber, mobile, data.expressCompanyName, 'success', data.logisticsStatusDesc, unifiedData);
                    
                    showToast('æŸ¥è¯¢æˆåŠŸï¼', 'success');
                    
                } else if (result.code === 201) {
                    statusCell.innerHTML = '<span class="query-status-badge query-status-failed">æš‚æ— è®°å½•</span>';
                    expressStatusCell.textContent = 'æš‚æ— ç‰©æµä¿¡æ¯';
                    companyCell.textContent = '-';
                    
                    await logQuery(expressNumber, mobile, '', 'failed', 'æš‚æ— è®°å½•', null);
                    showToast('æš‚æ— ç‰©æµä¿¡æ¯', 'error');
                    
                } else {
                    statusCell.innerHTML = '<span class="query-status-badge query-status-failed">æŸ¥è¯¢å¤±è´¥</span>';
                    expressStatusCell.textContent = result.msg || 'æŸ¥è¯¢å¤±è´¥';
                    companyCell.textContent = '-';
                    
                    await logQuery(expressNumber, mobile, '', 'failed', result.msg || '', null);
                    showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + (result.msg || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                
            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
                statusCell.innerHTML = '<span class="query-status-badge query-status-failed">æŸ¥è¯¢å¤±è´¥</span>';
                expressStatusCell.textContent = 'ç½‘ç»œé”™è¯¯';
                companyCell.textContent = '-';
                showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šæ‰¹é‡æŸ¥è¯¢
        // ========================================
        async function batchQuery() {
            const tbody = document.getElementById('queryTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            let pendingRows = [];
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const statusCell = row.cells[2];
                if (statusCell.textContent.includes('å¾…æŸ¥è¯¢')) {
                    const rowId = row.getAttribute('data-row-id');
                    pendingRows.push(rowId);
                }
            }
            
            if (pendingRows.length === 0) {
                showToast('æ²¡æœ‰å¾…æŸ¥è¯¢çš„å•å·', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ‰¹é‡æŸ¥è¯¢ ' + pendingRows.length + ' ä¸ªå•å·å—ï¼Ÿ')) {
                return;
            }
            
            showLoading('æ­£åœ¨æ‰¹é‡æŸ¥è¯¢...');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < pendingRows.length; i++) {
                const rowId = pendingRows[i];
                
                try {
                    await querySingleExpress(rowId);
                    successCount++;
                } catch (error) {
                    failCount++;
                }
                
                if (i < pendingRows.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            hideLoading();
            showToast('æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼æˆåŠŸï¼š' + successCount + 'ï¼Œå¤±è´¥ï¼š' + failCount, 'success');
        }

        // ========================================
        // ç”Ÿæˆç‰©æµè¯¦æƒ…HTML
        // ========================================
        function generateLogisticsDetailHTML(data) {
            let detailHTML = '<div class="logistics-details">';
            
            detailHTML += '<div class="logistics-header">';
            detailHTML += '<div class="logistics-header-left">';
            detailHTML += '<div class="logistics-title">ğŸ“¦ ç‰©æµè¯¦æƒ…</div>';
            
            detailHTML += '<div class="logistics-company">';
            if (data.company_logo) {
                detailHTML += '<img src="' + data.company_logo + '" class="company-logo" alt="logo">';
            }
            detailHTML += '<span class="company-name">' + (data.company || data.com || 'æœªçŸ¥å¿«é€’') + '</span>';
            detailHTML += '</div>';
            
            detailHTML += '<div class="logistics-meta">å•å·ï¼š' + (data.express_number || data.nu || '-') + '</div>';
            
            if (data.courier || data.courier_phone) {
                detailHTML += '<div class="logistics-meta courier-info">';
                if (data.courier) {
                    detailHTML += 'å¿«é€’å‘˜ï¼š' + data.courier;
                }
                if (data.courier_phone) {
                    detailHTML += ' ğŸ“ ' + data.courier_phone;
                }
                detailHTML += '</div>';
            }
            
            detailHTML += '</div>';
            
            detailHTML += '<div class="logistics-header-right">';
            detailHTML += '<span class="express-status status-' + (data.status_code || '') + '">' + (data.status || 'è¿è¾“ä¸­') + '</span>';
            
            if (data.take_time) {
                detailHTML += '<div style="font-size: 12px; color: #999; margin-top: 5px;">â±ï¸ ' + data.take_time + '</div>';
            }
            detailHTML += '</div>';
            detailHTML += '</div>';
            
            let logisticsList = data.list || data.data || [];
            
            if (logisticsList && logisticsList.length > 0) {
                const latestInfo = logisticsList[0];
                detailHTML += '<div class="logistics-info-box">';
                detailHTML += '<div class="info-row">';
                detailHTML += '<span class="info-label">æœ€æ–°åŠ¨æ€ï¼š</span>';
                detailHTML += '<span class="info-value">' + (latestInfo.status || latestInfo.context || latestInfo.desc || '') + '</span>';
                detailHTML += '</div>';
                detailHTML += '<div class="info-row">';
                detailHTML += '<span class="info-label">æ›´æ–°æ—¶é—´ï¼š</span>';
                detailHTML += '<span class="info-value">' + (latestInfo.time || latestInfo.ftime || '') + '</span>';
                detailHTML += '</div>';
                if (latestInfo.location || latestInfo.area || latestInfo.areaName) {
                    detailHTML += '<div class="info-row">';
                    detailHTML += '<span class="info-label">æ‰€åœ¨åœ°ï¼š</span>';
                    detailHTML += '<span class="info-value">' + (latestInfo.location || latestInfo.area || latestInfo.areaName || '') + '</span>';
                    detailHTML += '</div>';
                }
                detailHTML += '</div>';
            }
            
            detailHTML += '<div class="logistics-timeline">';
            detailHTML += '<div class="timeline-title">ğŸ“ ç‰©æµè½¨è¿¹</div>';
            
            if (logisticsList && logisticsList.length > 0) {
                for (let i = 0; i < logisticsList.length; i++) {
                    const item = logisticsList[i];
                    
                    let statusIcon = 'ğŸ“¦';
                    const statusCode = item.status_code || item.logisticsStatus;
                    if (statusCode === 'ACCEPT') statusIcon = 'ğŸ“¥';
                    else if (statusCode === 'TRANSPORT') statusIcon = 'ğŸšš';
                    else if (statusCode === 'DELIVERING') statusIcon = 'ğŸš´';
                    else if (statusCode === 'SIGN') statusIcon = 'âœ…';
                    else if (statusCode === 'PROBLEM') statusIcon = 'âš ï¸';
                    
                    detailHTML += '<div class="logistics-item">';
                    detailHTML += '<span class="logistics-time">' + (item.time || item.ftime || '') + '</span>';
                    detailHTML += '<div class="logistics-content">';
                    detailHTML += statusIcon + ' ' + (item.status || item.context || item.desc || '');
                    
                    if (item.location || item.area || item.areaName) {
                        detailHTML += '<div class="logistics-area">ğŸ“ ' + (item.location || item.area || item.areaName) + '</div>';
                    }
                    detailHTML += '</div>';
                    detailHTML += '</div>';
                }
            } else {
                detailHTML += '<div class="logistics-empty">';
                detailHTML += '<div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>';
                detailHTML += '<div>æš‚æ— ç‰©æµä¿¡æ¯</div>';
                detailHTML += '</div>';
            }
            
            detailHTML += '</div>';
            detailHTML += '</div>';
            
            return detailHTML;
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šæ˜¾ç¤ºç‰©æµè¯¦æƒ…
        // ========================================
        function showLogisticsDetail(rowId) {
            const data = queryDataCache[rowId];
            if (!data) {
                showToast('æš‚æ— ç‰©æµæ•°æ®', 'error');
                return;
            }
            
            const row = document.getElementById('queryRow-' + rowId);
            const existingDetail = row.nextElementSibling;
            
            if (existingDetail && existingDetail.classList.contains('logistics-detail-row')) {
                existingDetail.remove();
                return;
            }
            
            const detailRow = document.createElement('tr');
            detailRow.className = 'logistics-detail-row';
            
            const detailCell = document.createElement('td');
            detailCell.colSpan = 6;
            detailCell.innerHTML = generateLogisticsDetailHTML(data);
            
            detailRow.appendChild(detailCell);
            row.parentNode.insertBefore(detailRow, row.nextSibling);
        }

        // ========================================
        // ç”¨æˆ·æŸ¥è¯¢ï¼šå¯¼å‡ºExcel
        // ========================================
        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                showToast('Excelåº“æœªåŠ è½½ï¼Œæ— æ³•å¯¼å‡º', 'error');
                return;
            }
            
            const hasData = Object.keys(queryDataCache).length > 0;
            if (!hasData) {
                showToast('æš‚æ— æŸ¥è¯¢æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶...');
                
                const wb = XLSX.utils.book_new();
                
                const summaryData = [];
                summaryData.push(['å¿«é€’æŸ¥è¯¢è®°å½•']);
                summaryData.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                summaryData.push(['ç”¨æˆ·', currentUser.user_name + ' (' + currentUser.phone + ')']);
                summaryData.push([]);
                summaryData.push(['å¿«é€’å•å·', 'å¿«é€’å…¬å¸', 'å¿«é€’çŠ¶æ€', 'æœ€æ–°æ¶ˆæ¯', 'æ›´æ–°æ—¶é—´']);
                
                for (const rowId in queryDataCache) {
                    const data = queryDataCache[rowId];
                    const expressStatus = data.status || 'è¿è¾“ä¸­';
                    const latestInfo = data.list && data.list.length > 0 ? data.list[0] : null;
                    
                    summaryData.push([
                        data.express_number || data.nu || '',
                        data.company || data.com || '',
                        expressStatus,
                        latestInfo ? (latestInfo.status || latestInfo.context || '') : '',
                        latestInfo ? latestInfo.time : ''
                    ]);
                }
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [
                    { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 50 }, { wch: 20 }
                ];
                XLSX.utils.book_append_sheet(wb, summaryWs, 'æŸ¥è¯¢æ¦‚è§ˆ');
                
                for (const rowId in queryDataCache) {
                    const data = queryDataCache[rowId];
                    const detailData = [];
                    
                    detailData.push(['å¿«é€’å•å·ï¼š' + (data.express_number || data.nu || '')]);
                    detailData.push(['å¿«é€’å…¬å¸ï¼š' + (data.company || data.com || '')]);
                    detailData.push(['å¿«é€’çŠ¶æ€ï¼š' + (data.status || 'è¿è¾“ä¸­')]);
                    detailData.push([]);
                    detailData.push(['æ—¶é—´', 'ç‰©æµä¿¡æ¯', 'æ‰€åœ¨åœ°']);
                    
                    if (data.list && data.list.length > 0) {
                        for (let i = 0; i < data.list.length; i++) {
                            const item = data.list[i];
                            detailData.push([
                                item.time || '',
                                item.status || item.context || '',
                                item.location || ''
                            ]);
                        }
                    }
                    
                    const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                    detailWs['!cols'] = [
                        { wch: 20 }, { wch: 60 }, { wch: 20 }
                    ];
                    
                    const sheetName = (data.express_number || data.nu || 'unknown').substring(0, 20);
                    XLSX.utils.book_append_sheet(wb, detailWs, sheetName);
                }
                
                const fileName = 'å¿«é€’æŸ¥è¯¢è®°å½•_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx';
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // æ›´æ–°ç”¨æˆ·é¢åº¦
        // ========================================
        async function updateUserQuota() {
            if (!checkSupabaseInit()) return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ 
                        used_quota: currentUser.used_quota + 1 
                    })
                    .eq('id', currentUser.id);
                
                if (result.error) throw result.error;
                
                currentUser.used_quota += 1;
                updateUserPanel();
                
            } catch (error) {
                console.error('æ›´æ–°é¢åº¦å¤±è´¥:', error);
            }
        }

        // ========================================
        // è®°å½•æŸ¥è¯¢æ—¥å¿—
        // ========================================
        async function logQuery(expressNumber, mobile, companyName, status, expressStatus, logisticsData) {
            if (!checkSupabaseInit()) return;
            
            try {
                const logisticsJSON = logisticsData ? JSON.stringify(logisticsData) : null;
                
                await supabaseClient
                    .from('query_logs')
                    .insert([{
                        user_id: currentUser.id,
                        express_number: expressNumber,
                        mobile: mobile || null,
                        company_name: companyName || null,
                        status: status,
                        express_status: expressStatus || null,
                        logistics_data: logisticsJSON,
                        query_time: new Date().toISOString()
                    }]);
            } catch (error) {
                console.error('è®°å½•æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåŠ è½½æ‰€æœ‰ç”¨æˆ·
        // ========================================
        async function loadAdminData() {
            if (!checkSupabaseInit()) return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const users = result.data;
                const tbody = document.getElementById('adminUsersTableBody');
                tbody.innerHTML = '';
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr>' +
                        '<td colspan="8" style="text-align: center; padding: 40px; color: #999;">' +
                        'æš‚æ— ç”¨æˆ·æ•°æ®' +
                        '</td>' +
                        '</tr>';
                    return;
                }
                
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    const row = document.createElement('tr');
                    row.innerHTML = '<td>' + user.phone + '</td>' +
                        '<td>' + (user.user_name || 'æœªè®¾ç½®') + '</td>' +
                        '<td>' +
                        '<span class="level-badge level-' + user.level + '">' +
                        getLevelText(user.level) +
                        '</span>' +
                        '</td>' +
                        '<td>' + user.total_quota + '</td>' +
                        '<td>' + user.used_quota + '</td>' +
                        '<td>' + (user.total_quota - user.used_quota) + '</td>' +
                        '<td>' + formatDate(user.created_at) + '</td>' +
                        '<td>' +
                        '<button class="btn-table btn-edit" onclick="editUserQuota(' + user.id + ', ' + user.total_quota + ')">' +
                        'ä¿®æ”¹é¢åº¦' +
                        '</button>' +
                        '<button class="btn-table ' + (user.disabled ? 'btn-edit' : 'btn-disable') + '" ' +
                        'onclick="toggleUserStatus(' + user.id + ', ' + user.disabled + ')">' +
                        (user.disabled ? 'å¯ç”¨' : 'åœç”¨') +
                        '</button>' +
                        '<button class="btn-table btn-edit" onclick="editUserName(' + user.id + ', \'' + (user.user_name || '') + '\')">' +
                        'æ”¹å' +
                        '</button>' +
                        '</td>';
                    tbody.appendChild(row);
                }
                
                showToast('åŠ è½½æˆåŠŸï¼Œå…± ' + users.length + ' ä¸ªç”¨æˆ·', 'success');
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·é¢åº¦
        // ========================================
        async function editUserQuota(userId, currentQuota) {
            if (!checkSupabaseInit()) return;
            
            const newQuota = prompt('è¯·è¾“å…¥æ–°çš„æ€»é¢åº¦:', currentQuota);
            
            if (newQuota === null) return;
            
            if (!/^\d+$/.test(newQuota)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'error');
                return;
            }
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ total_quota: parseInt(newQuota) })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                showToast('ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåœç”¨/å¯ç”¨ç”¨æˆ·
        // ========================================
        async function toggleUserStatus(userId, currentStatus) {
            if (!checkSupabaseInit()) return;
            
            const action = currentStatus ? 'å¯ç”¨' : 'åœç”¨';
            
            if (!confirm('ç¡®å®šè¦' + action + 'è¯¥ç”¨æˆ·å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ disabled: !currentStatus })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                showToast('å·²' + action + 'ç”¨æˆ·', 'success');
                loadAdminData();
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·å
        // ========================================
        async function editUserName(userId, currentName) {
            if (!checkSupabaseInit()) return;
            
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å:', currentName);
            
            if (newName === null || newName.trim() === '') return;
            
            try {
                const result = await supabaseClient
                    .from('users')
                    .update({ user_name: newName.trim() })
                    .eq('id', userId);
                
                if (result.error) throw result.error;
                
                showToast('ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadAdminData();
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error);
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šå¯¼å‡ºç”¨æˆ·æ•°æ®
        // ========================================
        async function exportUsersToExcel() {
            if (!checkSupabaseInit()) return;
            
            try {
                showLoading('æ­£åœ¨å¯¼å‡ºç”¨æˆ·æ•°æ®...');
                
                const result = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                const users = result.data;
                
                if (users.length === 0) {
                    hideLoading();
                    showToast('æš‚æ— ç”¨æˆ·æ•°æ®', 'error');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                const data = [];
                data.push(['ç”¨æˆ·æ•°æ®å¯¼å‡º']);
                data.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                data.push(['ç”¨æˆ·æ€»æ•°', users.length + ' äºº']);
                data.push([]);
                data.push(['æ‰‹æœºå·', 'ç”¨æˆ·å', 'ä¼šå‘˜ç­‰çº§', 'æ€»é¢åº¦', 'å·²ä½¿ç”¨', 'å‰©ä½™é¢åº¦', 'è´¦æˆ·çŠ¶æ€', 'æ³¨å†Œæ—¶é—´']);
                
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    data.push([
                        user.phone || '',
                        user.user_name || '',
                        getLevelText(user.level),
                        user.total_quota || 0,
                        user.used_quota || 0,
                        (user.total_quota - user.used_quota) || 0,
                        user.disabled ? 'å·²åœç”¨' : 'æ­£å¸¸',
                        formatDate(user.created_at)
                    ]);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 10 },
                    { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 20 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'ç”¨æˆ·æ•°æ®');
                const fileName = 'ç”¨æˆ·æ•°æ®_' + new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + '.xlsx';
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                showToast('å¯¼å‡ºæˆåŠŸï¼å…± ' + users.length + ' æ¡ç”¨æˆ·æ•°æ®', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šå¯¼å‡ºæŸ¥è¯¢æ—¥å¿—
        // ========================================
        async function exportAllLogsToExcel() {
            if (!checkSupabaseInit()) return;
            
            try {
                showLoading('æ­£åœ¨å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—...');
                
                const result = await supabaseClient
                    .from('query_logs')
                    .select('*, users(phone, user_name)')
                    .order('created_at', { ascending: false })
                    .limit(1000);
                
                if (result.error) throw result.error;
                
                const logs = result.data;
                
                if (logs.length === 0) {
                    hideLoading();
                    showToast('æš‚æ— æŸ¥è¯¢æ—¥å¿—', 'error');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                
                const summaryData = [];
                summaryData.push(['æŸ¥è¯¢æ—¥å¿—å¯¼å‡º']);
                summaryData.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN')]);
                summaryData.push(['æ—¥å¿—æ€»æ•°', logs.length + ' æ¡']);
                summaryData.push([]);
                summaryData.push(['æŸ¥è¯¢æ—¶é—´', 'ç”¨æˆ·æ‰‹æœºå·', 'ç”¨æˆ·å', 'å¿«é€’å•å·', 'æ‰‹æœºå·', 'å¿«é€’å…¬å¸', 'å¿«é€’çŠ¶æ€', 'æŸ¥è¯¢çŠ¶æ€']);
                
                for (let i = 0; i < logs.length; i++) {
                    const log = logs[i];
                    summaryData.push([
                        formatDate(log.query_time || log.created_at),
                        log.users ? log.users.phone : '',
                        log.users ? log
.user_name : '',
                        log.express_number || '',
                        log.mobile || '',
                        log.company_name || '',
                        log.express_status || '',
                        log.status || ''
                    ]);
                }
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [
                    { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 20 },
                    { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
                ];
                
                XLSX.utils.book_append_sheet(wb, summaryWs, 'æŸ¥è¯¢æ—¥å¿—æ¦‚è§ˆ');
                
                let detailSheetCount = 0;
                
                for (let i = 0; i < logs.length; i++) {
                    const log = logs[i];
                    
                    if (!log.logistics_data || log.status !== 'success') continue;
                    
                    try {
                        const logisticsData = typeof log.logistics_data === 'string' ? 
                            JSON.parse(log.logistics_data) : log.logistics_data;
                        
                        const detailData = [];
                        
                        detailData.push(['æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯']);
                        detailData.push(['ç”¨æˆ·æ‰‹æœºå·', log.users ? log.users.phone : '']);
                        detailData.push(['ç”¨æˆ·å', log.users ? log.users.user_name : '']);
                        detailData.push(['æŸ¥è¯¢æ—¶é—´', formatDate(log.query_time || log.created_at)]);
                        detailData.push([]);
                        
                        detailData.push(['å¿«é€’è¯¦ç»†ä¿¡æ¯']);
                        detailData.push(['å¿«é€’å•å·', logisticsData.express_number || log.express_number || '']);
                        detailData.push(['å¿«é€’å…¬å¸', logisticsData.company || log.company_name || '']);
                        detailData.push(['å¿«é€’çŠ¶æ€', logisticsData.status || log.express_status || '']);
                        
                        if (logisticsData.courier || logisticsData.courier_phone) {
                            detailData.push(['å¿«é€’å‘˜', logisticsData.courier || '']);
                            detailData.push(['è”ç³»ç”µè¯', logisticsData.courier_phone || '']);
                        }
                        
                        if (logisticsData.take_time) {
                            detailData.push(['é…é€è€—æ—¶', logisticsData.take_time]);
                        }
                        
                        detailData.push([]);
                        detailData.push(['ç‰©æµè½¨è¿¹']);
                        detailData.push(['æ—¶é—´', 'ç‰©æµä¿¡æ¯', 'æ‰€åœ¨åœ°']);
                        
                        const logisticsList = logisticsData.list || logisticsData.data || [];
                        if (logisticsList && logisticsList.length > 0) {
                            for (let j = 0; j < logisticsList.length; j++) {
                                const trace = logisticsList[j];
                                detailData.push([
                                    trace.time || '',
                                    trace.status || trace.context || trace.desc || '',
                                    trace.location || trace.area || trace.areaName || ''
                                ]);
                            }
                        } else {
                            detailData.push(['', 'æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯', '']);
                        }
                        
                        const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                        detailWs['!cols'] = [
                            { wch: 20 }, { wch: 60 }, { wch: 20 }
                        ];
                        
                        detailSheetCount++;
                        const userName = log.users ? log.users.user_name : 'ç”¨æˆ·';
                        let sheetName = userName + '_' + (logisticsData.express_number || log.express_number || 'å•å·' + detailSheetCount);
                        
                        sheetName = sheetName.replace(/[:\\\/\?\*\[\]]/g, '').substring(0, 25);
                        
                        let finalSheetName = sheetName;
                        let suffix = 1;
                        while (wb.SheetNames.indexOf(finalSheetName) !== -1) {
                            finalSheetName = sheetName.substring(0, 20) + '_' + suffix;
                            suffix++;
                        }
                        
                        XLSX.utils.book_append_sheet(wb, detailWs, finalSheetName);
                        
                    } catch (error) {
                        console.error('å¤„ç†ç‰©æµæ•°æ®å¤±è´¥:', error);
                        continue;
                    }
                }
                
                const fileName = 'æŸ¥è¯¢æ—¥å¿—_' + 
                    new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + 
                    '.xlsx';
                
                XLSX.writeFile(wb, fileName);
                
                hideLoading();
                
                const message = 'å¯¼å‡ºæˆåŠŸï¼\n' +
                    'æ—¥å¿—è®°å½•ï¼š' + logs.length + ' æ¡\n' +
                    'è¯¦ç»†ç‰©æµï¼š' + detailSheetCount + ' ä¸ª';
                
                showToast(message, 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                hideLoading();
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ========================================
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç³»ç»Ÿ
        // ========================================
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...');
            
            // ç­‰å¾… Supabase åº“åŠ è½½
            let retryCount = 0;
            const maxRetries = 10;
            
            const waitForSupabase = setInterval(function() {
                retryCount++;
                
                if (typeof window.supabase !== 'undefined') {
                    clearInterval(waitForSupabase);
                    console.log('âœ… Supabase åº“åŠ è½½æˆåŠŸ');
                    
                    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
                    if (!initSupabase()) {
                        showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥ Excel åº“
                    if (typeof XLSX === 'undefined') {
                        console.error('âŒ Excelåº“åŠ è½½å¤±è´¥ï¼');
                        showToast('Excelåº“åŠ è½½å¤±è´¥ï¼Œå¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨', 'error');
                    } else {
                        console.log('âœ… Excelåº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', XLSX.version);
                    }
                    
                    // æ£€æŸ¥ç™»å½•çŠ¶æ€
                    checkLoginStatus();
                    
                } else if (retryCount >= maxRetries) {
                    clearInterval(waitForSupabase);
                    console.error('âŒ Supabase åº“åŠ è½½è¶…æ—¶ï¼');
                    showToast('ç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢', 'error');
                }
            }, 200);
        });

        // ========================================
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        // ========================================
        async function checkLoginStatus() {
            console.log('ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€...');
            
            if (authToken && authToken !== 'admin') {
                try {
                    showLoading('æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...');
                    
                    const result = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', parseInt(authToken))
                        .single();
                    
                    hideLoading();
                    
                    if (!result.error && result.data && !result.data.disabled) {
                        currentUser = result.data;
                        document.getElementById('unifiedLoginContainer').style.display = 'none';
                        document.getElementById('userInterface').classList.add('active');
                        updateUserPanel();
                        showQuerySection();
                        addQueryRow();
                        console.log('âœ… ç”¨æˆ·è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                    } else {
                        localStorage.removeItem('authToken');
                        authToken = null;
                        console.log('âš ï¸ è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                } catch (error) {
                    console.error('âŒ è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
                    hideLoading();
                    localStorage.removeItem('authToken');
                    authToken = null;
                }
            } else if (authToken === 'admin') {
                document.getElementById('unifiedLoginContainer').style.display = 'none';
                document.getElementById('adminInterface').classList.add('active');
                loadAdminData();
                console.log('âœ… ç®¡ç†å‘˜è‡ªåŠ¨ç™»å½•æˆåŠŸ');
            } else {
                console.log('â„¹ï¸ æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
            }
        }

        // ========================================
        // å®šæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯30ç§’ï¼‰
        // ========================================
        setInterval(function() {
            if (currentUser && authToken && authToken !== 'admin') {
                refreshUserInfo();
            }
        }, 30000);

        // ========================================
        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        // ========================================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + E: å¯¼å‡ºExcel
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    const historySection = document.getElementById('historySection');
                    if (historySection.classList.contains('active')) {
                        exportHistoryToExcel();
                    } else {
                        exportToExcel();
                    }
                }
            }
            
            // Ctrl/Cmd + N: æ·»åŠ æ–°è¡Œ
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    showQuerySection();
                    addQueryRow();
                }
            }
            
            // Ctrl/Cmd + B: æ‰¹é‡æŸ¥è¯¢
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    batchQuery();
                }
            }
            
            // Ctrl/Cmd + R: æ‰“å¼€å……å€¼å¼¹çª—
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    openRechargeModal();
                }
            }
            
            // Ctrl/Cmd + H: æ‰“å¼€å†å²è®°å½•
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                if (document.getElementById('userInterface').classList.contains('active')) {
                    showHistorySection();
                }
            }
            
            // ESC: å…³é—­å¼¹çª—
            if (e.key === 'Escape') {
                closeRechargeModal();
            }
        });

        console.log('âœ… å¿«é€’æŸ¥è¯¢ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
        console.log('ğŸ“‹ åŠŸèƒ½åˆ—è¡¨ï¼š');
        console.log('  - ç”¨æˆ·ç™»å½•/æ³¨å†Œ');
        console.log('  - å¿«é€’æŸ¥è¯¢ï¼ˆé˜¿é‡Œäº‘APIï¼‰');
        console.log('  - æ‰¹é‡æŸ¥è¯¢');
        console.log('  - Excelå¯¼å‡º');
        console.log('  - æŸ¥è¯¢å†å²è®°å½•ï¼ˆé›†æˆåœ¨æŸ¥è¯¢åŒºåŸŸï¼‰');
        console.log('  - å†å²è®°å½•ç­›é€‰');
        console.log('  - å†å²è®°å½•å†æ¬¡æŸ¥è¯¢');
        console.log('  - å†å²è®°å½•åˆ é™¤');
        console.log('  - å†å²è®°å½•å¯¼å‡ºï¼ˆå«å®Œæ•´ç‰©æµä¿¡æ¯ï¼‰');
        console.log('  - ç®€åŒ–å……å€¼æé†’');
        console.log('  - ç®¡ç†å‘˜åå°');
        console.log('  - ç”¨æˆ·ç®¡ç†');
        console.log('  - æ•°æ®å¯¼å‡º');
        console.log('ğŸ“Œ å¿«æ·é”®ï¼š');
        console.log('  - Ctrl/Cmd + E: å¯¼å‡ºExcel');
        console.log('  - Ctrl/Cmd + N: æ·»åŠ æŸ¥è¯¢');
        console.log('  - Ctrl/Cmd + B: æ‰¹é‡æŸ¥è¯¢');
        console.log('  - Ctrl/Cmd + R: æ‰“å¼€å……å€¼');
        console.log('  - Ctrl/Cmd + H: æ‰“å¼€å†å²è®°å½•');
        console.log('  - ESC: å…³é—­å¼¹çª—');
    </script>
</body>
</html>
